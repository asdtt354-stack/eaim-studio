<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬´ë‹ˆì™€ ê³¼í•™ ë§ˆë²•ì‚¬ - ì†Œë¦¬ì˜ ë¹„ë°€ (ë¦¬í¬íŠ¸ í¬í•¨)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&family=Noto+Serif+KR:wght@400;700&family=Gaegu&display=swap');

        body {
            margin: 0;
            background-color: #111;
            color: white;
            font-family: 'Jua', sans-serif;
            overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }

        /* --- [í™”ë©´ 1] ê²Œì„ í”Œë ˆì´ í™”ë©´ --- */
        #game-screen {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle, #2b1055, #000);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }

        /* ì§„í–‰ ìƒíƒœ í‘œì‹œë°” */
        #progress-bar {
            width: 0%; height: 10px; background: #ff4081; position: absolute; top: 0; left: 0; z-index: 100; transition: width 0.5s;
        }

        /* ëŒ€í™”ì°½ UI */
        #dialogue-box {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 800px; height: 150px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px; border: 5px solid #ffca28;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 10;
            display: none; align-items: center; padding: 20px; color: #333;
        }
        #char-portrait { width: 100px; height: 100px; border-radius: 50%; background-color: #fff; margin-right: 20px; border: 3px solid #ffca28; display: flex; justify-content: center; align-items: center; font-size: 50px; flex-shrink: 0; }
        #text-content { flex-grow: 1; }
        #char-name { font-size: 24px; color: #d81b60; margin-bottom: 10px; font-weight: bold; }
        #dialogue-text { font-size: 22px; line-height: 1.5; }

        /* ì‹œì‘ í™”ë©´ */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 20;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        #start-btn {
            padding: 20px 50px; font-size: 30px; font-family: 'Jua', sans-serif;
            background: linear-gradient(45deg, #ff4081, #ffca28); color: white; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 0 20px rgba(255, 64, 129, 0.6); animation: bounce 2s infinite;
        }

        /* --- [í™”ë©´ 2] ê¸€ì“°ê¸° í™”ë©´ (Writing Screen) --- */
        #writing-screen {
            display: none; /* ê²Œì„ ëë‚˜ë©´ ë³´ì„ */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 50;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .writing-card {
            background: white; color: #333; width: 90%; max-width: 600px; padding: 30px; border-radius: 20px;
            box-shadow: 0 0 30px rgba(255, 202, 40, 0.5); text-align: center;
        }
        .writing-card h2 { color: #d81b60; margin-top: 0; }
        .question-group { margin-bottom: 20px; text-align: left; }
        .question-label { display: block; font-size: 18px; margin-bottom: 8px; color: #555; font-weight: bold; }
        .input-area {
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-family: 'Gaegu'; font-size: 20px;
            box-sizing: border-box; background: #f9f9f9;
        }
        .finish-btn {
            background: #2e7d32; color: white; border: none; padding: 15px 40px; font-size: 22px; border-radius: 50px;
            cursor: pointer; font-family: 'Jua'; margin-top: 10px;
        }

        /* --- [í™”ë©´ 3] ìµœì¢… ë¦¬í¬íŠ¸ (Report Screen - ì¸ì‡„ìš©) --- */
        #report-screen {
            display: none; width: 100%; min-height: 100vh; background-color: #e0e0e0;
            justify-content: center; padding: 40px 0; color: #333;
        }
        #journal-paper {
            width: 210mm; min-height: 297mm; background: #fff; padding: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); box-sizing: border-box; position: relative;
        }
        /* ì¢…ì´ ì§ˆê° */
        #journal-paper::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: linear-gradient(#f0f0f0 1px, transparent 1px); background-size: 100% 2em; opacity: 0.3; pointer-events: none;
        }

        h1.report-title { font-family: 'Gaegu'; font-size: 45px; color: #2b1055; text-align: center; border-bottom: 3px double #2b1055; padding-bottom: 10px; margin-bottom: 40px; }
        .report-section { margin-bottom: 30px; }
        .report-label { font-size: 20px; font-weight: bold; color: #d81b60; margin-bottom: 10px; display: block; border-left: 5px solid #ffca28; padding-left: 10px; font-family: 'Noto Serif KR'; }
        
        #captured-art {
            width: 100%; height: 300px; background: #000; border: 5px solid #222; object-fit: cover; display: block; margin: 0 auto;
        }
        .answer-box {
            font-family: 'Gaegu'; font-size: 24px; line-height: 1.8; color: #000; background: rgba(255, 202, 40, 0.1); padding: 15px; border-radius: 10px; min-height: 50px;
        }

        .btn-group { margin-top: 20px; text-align: center; }
        .action-btn { padding: 15px 30px; font-size: 20px; border: none; border-radius: 50px; cursor: pointer; margin: 0 10px; font-family: 'Jua'; }
        .print-btn { background: #2b1055; color: white; }
        .restart-btn { background: #ff9800; color: white; }

        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* ì¸ì‡„ ì„¤ì • */
        @media print {
            body { background: white; -webkit-print-color-adjust: exact; }
            #game-screen, #writing-screen { display: none !important; }
            #report-screen { display: flex !important; padding: 0; background: white; }
            #journal-paper { box-shadow: none; margin: 0; width: 100%; border: none; }
            .btn-group { display: none; }
        }
    </style>
</head>
<body>

    <div id="game-screen">
        <div id="progress-bar"></div>
        <canvas id="visualizer"></canvas>

        <div id="dialogue-box">
            <div id="char-portrait">ğŸ§™â€â™‚ï¸</div>
            <div id="text-content">
                <div id="char-name">ë¬´ë‹ˆ</div>
                <div id="dialogue-text">...</div>
            </div>
        </div>

        <div id="start-overlay">
            <h1 style="font-size: 50px; margin-bottom: 20px; color: #ffca28;">ë¬´ë‹ˆì™€ ê³¼í•™ ë§ˆë²•ì‚¬</h1>
            <h2 style="color: white; margin-bottom: 50px;">EP1. ì†Œë¦¬ì˜ ë¹„ë°€</h2>
            <button id="start-btn">íƒí—˜ ì‹œì‘í•˜ê¸° â–¶</button>
            <p style="color: #aaa; margin-top: 20px;">* ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”</p>
        </div>
    </div>

    <div id="writing-screen">
        <div class="writing-card">
            <h2>âœ¨ ì†Œë¦¬ ë§ˆë²• íƒí—˜ ì„±ê³µ!</h2>
            <p>ì˜¤ëŠ˜ ì²´í—˜ì„ ë‚˜ë§Œì˜ ì—ì„¸ì´ë¡œ ë‚¨ê²¨ë³´ì„¸ìš”.</p>
            
            <div class="question-group">
                <label class="question-label">1. ë‚´ ëª©ì†Œë¦¬ë¥¼ ìƒ‰ê¹”ë¡œ í‘œí˜„í•œë‹¤ë©´ ë¬´ìŠ¨ ìƒ‰ì¸ê°€ìš”?</label>
                <input type="text" id="input-q1" class="input-area" placeholder="ì˜ˆ: ì”©ì”©í•œ ë¹¨ê°„ìƒ‰, ë¶€ë“œëŸ¬ìš´ íŒŒë€ìƒ‰...">
            </div>
            
            <div class="question-group">
                <label class="question-label">2. ì˜¤ëŠ˜ ë§Œë“  'í° ì†Œë¦¬ ì—ë„ˆì§€'ë¥¼ ëˆ„êµ¬ì—ê²Œ ë³´ë‚´ì£¼ê³  ì‹¶ë‚˜ìš”?</label>
                <textarea id="input-q2" class="input-area" rows="2" placeholder="ì˜ˆ: ë§¤ì¼ ì¼í•˜ëŠë¼ í˜ë“œì‹  ì•„ë¹ ì—ê²Œ..."></textarea>
            </div>

            <div class="question-group">
                <label class="question-label">3. ë‚˜ì˜ ì´ë¦„(ë³„ëª…)</label>
                <input type="text" id="input-name" class="input-area" placeholder="ì†Œë¦¬ ë§ˆë²•ì‚¬ 000">
            </div>

            <button class="finish-btn" onclick="generateReport()">ì™„ì„±í•˜ê³  ë¦¬í¬íŠ¸ ë³´ê¸°</button>
        </div>
    </div>

    <div id="report-screen">
        <div id="journal-paper">
            <h1 class="report-title">ğŸ¨ ë‚˜ì˜ ì†Œë¦¬ ì˜ˆìˆ  ë¦¬í¬íŠ¸</h1>
            
            <div class="report-section" style="display:flex; justify-content:space-between; border-bottom: 2px solid #ddd; padding-bottom:10px;">
                <div style="font-family:'Gaegu'; font-size:24px;">ì´ë¦„: <span id="report-name"></span></div>
                <div style="font-family:'Gaegu'; font-size:24px;">ë‚ ì§œ: <span id="report-date"></span></div>
            </div>

            <div class="report-section">
                <span class="report-label">ë‚´ê°€ ë§Œë“  ì†Œë¦¬ íŒŒë™ ì‘í’ˆ</span>
                <p style="font-size:14px; color:#666; margin-bottom:5px;">* ë‚˜ì˜ ëª©ì†Œë¦¬ ì—ë„ˆì§€ê°€ ë§Œë“  ì„¸ìƒì— í•˜ë‚˜ë¿ì¸ ê·¸ë¦¼ì…ë‹ˆë‹¤.</p>
                <img id="captured-art" src="" alt="ì†Œë¦¬ ì˜ˆìˆ  ì‘í’ˆ">
            </div>

            <div class="report-section">
                <span class="report-label">Q1. ë‚˜ì˜ ëª©ì†Œë¦¬ ìƒ‰ê¹”ì€?</span>
                <div id="ans-q1" class="answer-box"></div>
            </div>

            <div class="report-section">
                <span class="report-label">Q2. ì—ë„ˆì§€ë¥¼ ë³´ë‚´ê³  ì‹¶ì€ ì‚¬ëŒì€?</span>
                <div id="ans-q2" class="answer-box"></div>
            </div>

            <div class="report-section" style="margin-top:50px; text-align: center;">
                <p style="font-family: 'Gaegu'; font-size: 20px; color: #2b1055;">
                    "ì†Œë¦¬ëŠ” ëˆˆì— ë³´ì´ì§€ ì•Šì§€ë§Œ, ì„¸ìƒì„ ì›€ì§ì´ëŠ” í˜ì´ ìˆë‹¨ë‹¤."<br>
                    - ë¬´ë‹ˆ ì„ ìƒë‹˜ -
                </p>
            </div>
        </div>

        <div class="btn-group">
            <button class="action-btn restart-btn" onclick="location.reload()">ğŸ”„ ë‹¤ì‹œ í•˜ê¸°</button>
            <button class="action-btn print-btn" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„ / PDF ì €ì¥</button>
        </div>
    </div>

    <script>
        // ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„°
        const scenario = [
            { id: 1, name: "ë¬´ë‹ˆ (ë¦¬ë”)", emoji: "ğŸ§™â€â™‚ï¸", text: "ì•ˆë…•? ë‚œ ë¬´ë‹ˆì•¼. <br>ì—¬ê¸°ëŠ” ì†Œë¦¬ê°€ ê·¸ë¦¼ì´ ë˜ëŠ” ë§ˆë²•ì˜ ìˆ²ì´ì•¼.", type: "click" },
            { id: 2, name: "ë¬´í†  (ì—”ì§€ë‹ˆì–´)", emoji: "ğŸ‘·", text: "ì•—, ë„ˆë¬´ ì–´ë‘ì›Œ! <br>ì‘ì€ ì†Œë¦¬ë¡œ 'ë°˜ì§'í•˜ê³  ì†ì‚­ì—¬ì¤„ë˜?", type: "sound_low", threshold: 10 },
            { id: 3, name: "ë¬´ì§€ (ì˜ˆìˆ ê°€)", emoji: "ğŸ¨", text: "ì™€! ë¹›ì´ ìƒê²¼ì–´! <br>ì´ë²ˆì—” ì•„ì£¼ í° ì†Œë¦¬ë¡œ 'ì•¼í˜¸!' í•˜ê³  ì™¸ì³ë´!", type: "sound_high", threshold: 50 },
            { id: 4, name: "ë¬´ì§€ (ì˜ˆìˆ ê°€)", emoji: "ğŸŒˆ", text: "ëŒ€ë‹¨í•´!! ë„¤ ëª©ì†Œë¦¬ê°€ <br>í™”ë ¤í•œ ë¬´ì§€ê°œ íŒŒë„ê°€ ë˜ì—ˆì–´!", type: "auto" },
            { id: 5, name: "ë¬´ì§„ (ì‹œì¸)", emoji: "ğŸŒ¿", text: "ì°¸ ì•„ë¦„ë‹µë‹¤... <br>ì´ ì•„ë¦„ë‹¤ìš´ ì†Œë¦¬ë¥¼ ê¸°ë¡í•˜ëŸ¬ ê°€ë³¼ê¹Œ?", type: "end" }
        ];

        // ë³€ìˆ˜ ì„¤ì •
        let currentStep = 0;
        let audioContext, analyser, dataArray;
        let isListening = false;
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const dialogueBox = document.getElementById('dialogue-box');
        
        // ìº”ë²„ìŠ¤ í¬ê¸°
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // ì‹œì‘ ë²„íŠ¼
        document.getElementById('start-btn').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                document.getElementById('start-overlay').style.display = 'none';
                dialogueBox.style.display = 'flex';
                isListening = true;
                drawVisualizer();
                loadStep(0);
            } catch (err) {
                alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤!");
            }
        });

        // ëŒ€í™”ì°½ í´ë¦­
        dialogueBox.addEventListener('click', () => {
            if (scenario[currentStep].type === 'click') nextStep();
        });

        function loadStep(index) {
            if (index >= scenario.length) return;
            currentStep = index;
            const scene = scenario[index];
            document.getElementById('char-name').innerText = scene.name;
            document.getElementById('char-name').style.color = getCharColor(scene.name);
            document.getElementById('dialogue-text').innerHTML = scene.text;
            document.getElementById('char-portrait').innerText = scene.emoji;
            document.getElementById('progress-bar').style.width = ((index + 1) / scenario.length) * 100 + "%";

            if (scene.type === 'auto') setTimeout(nextStep, 3500);
            if (scene.type === 'end') {
                // ì—”ë”©ì¼ ë•Œ ì ì‹œ ë³´ì—¬ì£¼ê³  ê¸€ì“°ê¸° í™”ë©´ìœ¼ë¡œ ì´ë™
                setTimeout(() => {
                    document.getElementById('game-screen').style.display = 'none'; // ê²Œì„ í™”ë©´ ìˆ¨ê¹€ (í•˜ì§€ë§Œ ìº”ë²„ìŠ¤ëŠ” ì‚´ì•„ìˆìŒ)
                    document.getElementById('writing-screen').style.display = 'flex'; // ê¸€ì“°ê¸° í™”ë©´ ë“±ì¥
                }, 3000);
            }
        }

        function nextStep() {
            if (currentStep < scenario.length - 1) loadStep(currentStep + 1);
        }

        function getCharColor(name) {
            if (name.includes("ë¬´ë‹ˆ")) return "#d81b60";
            if (name.includes("ë¬´í† ")) return "#1e88e5";
            if (name.includes("ë¬´ì§€")) return "#ffca28";
            if (name.includes("ë¬´ì§„")) return "#43a047";
            return "#333";
        }

        // [í•µì‹¬] ë¦¬í¬íŠ¸ ìƒì„± í•¨ìˆ˜
        function generateReport() {
            // 1. ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
            const name = document.getElementById('input-name').value || "ìµëª…ì˜ ì†Œë¦¬ ë§ˆë²•ì‚¬";
            const q1 = document.getElementById('input-q1').value || "ë¬´ì§€ê°œìƒ‰";
            const q2 = document.getElementById('input-q2').value || "ë‚˜ ìì‹ ì—ê²Œ";
            
            // 2. ë¦¬í¬íŠ¸ì— ë„£ê¸°
            document.getElementById('report-name').innerText = name;
            const today = new Date();
            document.getElementById('report-date').innerText = `${today.getFullYear()}ë…„ ${today.getMonth()+1}ì›” ${today.getDate()}ì¼`;
            document.getElementById('ans-q1').innerText = q1;
            document.getElementById('ans-q2').innerText = q2;

            // 3. ìº”ë²„ìŠ¤ ê·¸ë¦¼ ìº¡ì²˜ (ë°°ê²½ì´ ê²€ì€ìƒ‰ì´ë¼ ë¦¬í¬íŠ¸ì—ì„  ë°˜ì „íš¨ê³¼ì²˜ëŸ¼ ë³´ì„ -> ê·¸ëŒ€ë¡œ ì”€)
            // *ì¤‘ìš”: ìº”ë²„ìŠ¤ì˜ í˜„ì¬ ìƒíƒœë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
            const dataURL = canvas.toDataURL('image/png');
            document.getElementById('captured-art').src = dataURL;

            // 4. í™”ë©´ ì „í™˜
            document.getElementById('writing-screen').style.display = 'none';
            document.getElementById('report-screen').style.display = 'flex';
        }

        // ì‹œê°í™” ë£¨í”„
        function drawVisualizer() {
            if(!isListening) return;
            requestAnimationFrame(drawVisualizer);
            analyser.getByteFrequencyData(dataArray);

            // ë°°ê²½: ì”ìƒ íš¨ê³¼ë¥¼ ìœ„í•´ íˆ¬ëª…ë„ ìˆëŠ” ê²€ì€ìƒ‰ ë®ê¸°
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            let averageVolume = sum / dataArray.length;

            const barWidth = (canvas.width / dataArray.length) * 2.5;
            let x = 0;
            for (let i = 0; i < dataArray.length; i++) {
                let barHeight = dataArray[i] * 1.5;
                
                // ìºë¦­í„°ë³„ ìƒ‰ìƒ í…Œë§ˆ ì ìš©
                let r, g, b;
                if (scenario[currentStep] && scenario[currentStep].name.includes("ë¬´í† ")) { 
                     r = 50; g = 50; b = barHeight + 100; // íŒŒë‘
                } else if (scenario[currentStep] && scenario[currentStep].name.includes("ë¬´ì§€")) { 
                     r = barHeight + 50; g = x % 255; b = 50; // ì•Œë¡ë‹¬ë¡
                } else { 
                     r = barHeight + 25 * (i / dataArray.length); g = 250 * (i / dataArray.length); b = 50; // ê¸°ë³¸
                }

                ctx.fillStyle = `rgb(${r},${g},${b})`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }

            checkSoundMission(averageVolume);
        }

        function checkSoundMission(volume) {
            const scene = scenario[currentStep];
            if (scene.type === 'sound_low') {
                if (volume > scene.threshold && volume < 40) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.1)'; ctx.fillRect(0,0,canvas.width, canvas.height);
                    if(!scene.cleared) { scene.cleared = true; setTimeout(nextStep, 1000); }
                }
            }
            if (scene.type === 'sound_high') {
                if (volume > scene.threshold) {
                    // ì„±ê³µ ì‹œ í™”ë ¤í•œ í­ì£½ íš¨ê³¼
                    ctx.fillStyle = `rgba(${Math.random()*255}, ${Math.random()*255}, ${Math.random()*255}, 0.5)`;
                    ctx.fillRect(0,0,canvas.width, canvas.height);
                    if(!scene.cleared) { scene.cleared = true; setTimeout(nextStep, 1500); }
                }
            }
        }
    </script>
</body>
</html>