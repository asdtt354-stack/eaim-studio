<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAIM ì˜ì–´ ë¬¸ì¥ ë†€ì´í„° (ì™•ê¸€ì”¨ & ë¹ ë¥¸ì†Œë¦¬)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Fredoka:wght@400;600&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #EFF6FF; } /* Blue-50 */
        .font-eng { font-family: 'Fredoka', sans-serif; }
        .font-hand { font-family: 'Gaegu', cursive; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card-btn { transition: all 0.1s; }
        .card-btn:active { transform: scale(0.95); }
        .card-btn:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .tab-btn { transition: all 0.2s; border-bottom-width: 4px; }
        .tab-btn.active { background-color: #2563EB; color: white; border-color: #1E40AF; transform: translateY(-2px); }
        .tab-btn.inactive { background-color: white; color: #6B7280; border-color: #DBEAFE; }
        .tab-btn:active { transform: translateY(0); border-bottom-width: 2px; }

        .input-underline {
            border-bottom: 4px dashed #BFDBFE;
            transition: all 0.3s;
        }
        .input-underline:focus {
            border-bottom: 4px solid #2563EB;
            background-color: rgba(239, 246, 255, 0.5);
        }

        .speaking-icon { animation: pulse-blue 1.5s infinite; }
        @keyframes pulse-blue { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

        @media print {
            body { background: white; }
            header, .sticky-nav, .no-print, #common-tools, .tab-btn { display: none !important; }
            #root-container { box-shadow: none; border: none; width: 100%; max-width: 100%; }
            .print-only-show { display: block !important; }
            #tab-5 { display: block !important; }
            .story-item { border: 1px solid #ccc; break-inside: avoid; }
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800 min-h-screen pb-20 text-lg">

    <div id="root-container" class="max-w-2xl mx-auto min-h-screen bg-white shadow-2xl flex flex-col relative border-x-2 border-blue-100">
        
        <header class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6 text-white shadow-xl z-20 rounded-b-[2.5rem]">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold font-hand flex items-center drop-shadow-md">
                        <i class="fa-solid fa-shapes mr-3 text-yellow-300"></i> EAIM ì˜ì–´ë†€ì´í„°
                    </h1>
                    <p class="text-lg text-blue-100 font-medium ml-2 mt-1">Step-by-Step Sentence Builder</p>
                </div>
                <button onclick="resetAll()" class="text-sm bg-white/20 hover:bg-white/30 px-4 py-2 rounded-2xl transition backdrop-blur-sm border-2 border-white/20">
                    <i class="fa-solid fa-rotate-right mr-1"></i> ì´ˆê¸°í™”
                </button>
            </div>
        </header>

        <div class="sticky-nav sticky top-0 bg-white/95 backdrop-blur-sm z-10 shadow-sm border-b-2 border-blue-100 p-4 flex justify-center gap-2 overflow-x-auto hide-scrollbar">
            <button onclick="switchTab(1)" id="btn-tab-1" class="tab-btn active flex-1 min-w-[70px] py-3 rounded-2xl font-bold text-lg font-hand leading-tight border-2">
                Step 1<br><span class="text-xs font-sans font-normal opacity-90">ë¼ˆëŒ€</span>
            </button>
            <button onclick="switchTab(2)" id="btn-tab-2" class="tab-btn inactive flex-1 min-w-[70px] py-3 rounded-2xl font-bold text-lg font-hand leading-tight border-2">
                Step 2<br><span class="text-xs font-sans font-normal opacity-90">ì´ìŒ</span>
            </button>
            <button onclick="switchTab(3)" id="btn-tab-3" class="tab-btn inactive flex-1 min-w-[70px] py-3 rounded-2xl font-bold text-lg font-hand leading-tight border-2">
                Step 3<br><span class="text-xs font-sans font-normal opacity-90">ê¾¸ë°ˆ</span>
            </button>
            <button onclick="switchTab(4)" id="btn-tab-4" class="tab-btn inactive flex-1 min-w-[70px] py-3 rounded-2xl font-bold text-lg font-hand leading-tight border-2 bg-purple-50 border-purple-200 text-purple-700">
                Step 4<br><span class="text-xs font-sans font-normal opacity-90">ë ˆë²¨ì—…</span>
            </button>
            <button onclick="switchTab(5)" id="btn-tab-5" class="tab-btn inactive flex-1 min-w-[70px] py-3 rounded-2xl font-bold text-lg font-hand leading-tight border-2 bg-yellow-50 border-yellow-200 text-yellow-700">
                Step 5<br><span class="text-xs font-sans font-normal opacity-90">ì™„ì„±</span>
            </button>
        </div>

        <div class="px-6 mt-6 flex-grow overflow-y-auto hide-scrollbar pb-10">

            <div id="common-tools" class="mb-8">
                <div class="bg-blue-50 p-6 rounded-[2rem] border-2 border-blue-100 mb-6 shadow-inner">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-blue-800 font-eng flex items-center">
                            <span class="bg-blue-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2 shadow-sm">1</span>
                            Today's Emotion
                        </h3>
                        <span class="text-sm text-blue-400 font-bold">í•˜ë‚˜ë¥¼ ê³¨ë¼ë³´ì„¸ìš”!</span>
                    </div>
                    
                    <div id="emotion-list" class="flex flex-wrap gap-3 justify-center pb-2"></div>
                    
                    <div id="selected-emotion-display" class="hidden mt-4 bg-white p-4 rounded-2xl text-center border-4 border-blue-200 shadow-lg animate-fade-in">
                        <span class="text-sm text-gray-400 mr-2 block mb-1">ì„ íƒì™„ë£Œ! (Selected)</span>
                        <span id="emotion-text" class="font-bold font-eng text-3xl text-blue-600"></span>
                    </div>
                </div>

                <div class="bg-slate-800 p-6 rounded-[2rem] shadow-xl text-white transform transition hover:scale-[1.01] border-4 border-slate-700">
                    <h3 class="text-sm font-bold font-eng mb-3 text-yellow-400 uppercase tracking-wider flex items-center">
                        <i class="fa-solid fa-magnifying-glass mr-2"></i> Word Helper (ë‹¨ì–´ ë„ìš°ë¯¸)
                    </h3>
                    <div class="flex gap-3">
                        <input type="text" id="search-input" placeholder="ê¶ê¸ˆí•œ ë‹¨ì–´ (ì˜ˆ: í•™êµ)" class="flex-1 px-4 py-3 rounded-xl text-gray-800 text-lg font-bold font-hand focus:outline-none focus:ring-4 focus:ring-yellow-400">
                        <button id="naver-btn" class="hidden bg-green-500 hover:bg-green-600 px-4 py-3 rounded-xl text-sm font-bold font-eng transition shadow-lg text-white border-b-4 border-green-700 active:border-b-0 active:translate-y-1">ì‚¬ì „</button>
                    </div>
                    <div id="search-result-box" class="hidden mt-3 text-lg bg-gray-700/80 p-3 rounded-xl border border-gray-600 text-center"></div>
                </div>
            </div>

            <div id="tab-1" class="tab-content active space-y-8">
                <div class="text-center">
                    <span class="bg-blue-100 text-blue-600 px-4 py-1.5 rounded-full text-sm font-bold font-eng">Step 1</span>
                    <h3 class="text-3xl font-bold text-gray-700 font-hand mt-2">ëˆ„ê°€ ë¬´ì—‡ì„ í–ˆë‚˜ìš”?</h3>
                </div>
                
                <div class="bg-white p-6 rounded-[2rem] border-4 border-red-100 shadow-md relative group hover:border-red-300 transition">
                    <div class="absolute -top-3 left-6 bg-red-100 text-red-500 px-3 py-1 rounded-lg text-xs font-bold font-eng">WHO (ì£¼ì–´)</div>
                    <input type="text" id="l1-who" class="input-underline w-full text-center text-5xl font-eng font-bold text-gray-700 focus:outline-none placeholder-gray-200 py-2" placeholder="I" oninput="updateL1()">
                </div>
                
                <div class="text-center text-blue-300 text-2xl animate-bounce"><i class="fa-solid fa-arrow-down"></i></div>

                <div class="bg-yellow-50 p-6 rounded-[2rem] border-4 border-yellow-200 shadow-md relative group hover:border-yellow-400 transition">
                    <div class="absolute -top-3 left-6 bg-yellow-100 text-yellow-700 px-3 py-1 rounded-lg text-xs font-bold font-eng">ACTION (ë™ì‚¬)</div>
                    <div id="action-list" class="flex flex-wrap gap-3 justify-center py-4"></div>
                    <div class="mt-4 bg-white px-4 py-3 rounded-2xl border-2 border-yellow-100 flex items-center shadow-sm">
                         <span class="text-xs font-bold text-gray-400 mr-3 whitespace-nowrap">ì§ì ‘ì…ë ¥:</span>
                         <input type="text" id="l1-action" class="flex-1 text-center text-3xl font-eng focus:outline-none text-blue-600 font-bold" placeholder="feel" oninput="updateL1()">
                    </div>
                </div>

                <div class="text-center text-blue-300 text-2xl animate-bounce"><i class="fa-solid fa-arrow-down"></i></div>

                <div class="bg-white p-6 rounded-[2rem] border-4 border-green-100 shadow-md relative group hover:border-green-300 transition">
                    <div class="absolute -top-3 left-6 bg-green-100 text-green-600 px-3 py-1 rounded-lg text-xs font-bold font-eng">WHAT (ë¬´ì—‡/ìƒíƒœ)</div>
                    <input type="text" id="l1-what" class="input-underline w-full text-center text-5xl font-eng font-bold text-gray-700 focus:outline-none placeholder-gray-200 py-2" placeholder="..." oninput="updateL1()">
                </div>

                <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-1.5 rounded-[2rem] shadow-xl mt-8">
                    <div class="bg-white rounded-[1.7rem] p-6 text-center">
                        <p class="text-sm text-gray-400 mb-2 font-hand font-bold">ì™„ì„±ëœ ë¬¸ì¥</p>
                        <p id="l1-result" class="font-eng text-4xl mb-6 text-gray-800 font-bold tracking-tight break-words">...</p>
                        <button onclick="speakL1()" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-700 py-4 rounded-2xl font-bold transition flex items-center justify-center gap-3 text-xl shadow-md transform active:scale-95">
                            <i id="icon-vol-1" class="fa-solid fa-volume-high"></i> Listen (ë“¤ì–´ë³´ê¸°)
                        </button>
                    </div>
                </div>
            </div>

            <div id="tab-2" class="tab-content space-y-8">
                <div class="text-center">
                    <span class="bg-purple-100 text-purple-600 px-4 py-1.5 rounded-full text-sm font-bold font-eng">Step 2</span>
                    <h3 class="text-3xl font-bold text-gray-700 font-hand mt-2">ë¬¸ì¥ ê¸¸ê²Œ ë§Œë“¤ê¸° (ì ‘ì†ì‚¬)</h3>
                </div>
                
                <div class="bg-purple-50 p-6 rounded-[2rem] border-4 border-purple-100 space-y-6 shadow-inner">
                    <div class="relative bg-white p-4 rounded-2xl border-2 border-purple-200 shadow-sm">
                        <span class="absolute -top-3 left-6 bg-purple-100 text-purple-600 text-xs px-2 py-1 rounded font-bold font-eng">ì• ë¬¸ì¥ (Step 1)</span>
                        <input type="text" id="l2-a" class="w-full text-center font-eng text-2xl text-gray-700 bg-transparent border-none focus:outline-none" placeholder="I feel happy" readonly>
                    </div>
                    
                    <div class="flex justify-center items-center gap-3 py-2 bg-white/50 rounded-2xl p-2">
                        <button onclick="setConn('because')" class="conn-btn px-4 py-2 rounded-xl text-base font-bold font-eng bg-purple-500 text-white shadow-md hover:bg-purple-600 border-b-4 border-purple-700 active:border-b-0 active:translate-y-1">because</button>
                        <button onclick="setConn('when')" class="conn-btn px-4 py-2 rounded-xl text-base font-bold font-eng bg-white text-gray-500 border-2 hover:bg-gray-50 border-gray-300">when</button>
                        <button onclick="setConn('but')" class="conn-btn px-4 py-2 rounded-xl text-base font-bold font-eng bg-white text-gray-500 border-2 hover:bg-gray-50 border-gray-300">but</button>
                    </div>

                    <div class="relative bg-white p-6 rounded-[2rem] border-4 border-dashed border-purple-300 hover:border-purple-400 transition">
                        <span class="absolute -top-3 left-6 bg-purple-500 text-white text-xs px-2 py-1 rounded font-bold font-eng shadow-sm">ë’¤ ë¬¸ì¥ ë§Œë“¤ê¸°</span>
                        
                        <div class="flex flex-col gap-4 mt-2">
                            <div class="flex items-center gap-3">
                                <span class="text-xs bg-red-100 text-red-500 px-2 py-1 rounded-lg font-bold w-14 text-center">Who</span>
                                <input type="text" id="l2-b-who" class="flex-1 p-3 bg-gray-50 rounded-xl text-xl font-eng focus:outline-none focus:ring-2 focus:ring-purple-300 border border-gray-200" placeholder="ëˆ„ê°€ (I)" oninput="updateL2()">
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs bg-yellow-100 text-yellow-600 px-2 py-1 rounded-lg font-bold w-14 text-center">Action</span>
                                <input type="text" id="l2-b-action" class="flex-1 p-3 bg-gray-50 rounded-xl text-xl font-eng focus:outline-none focus:ring-2 focus:ring-purple-300 border border-gray-200" placeholder="ë™ì‚¬ (met)" oninput="updateL2()">
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded-lg font-bold w-14 text-center">What</span>
                                <input type="text" id="l2-b-what" class="flex-1 p-3 bg-gray-50 rounded-xl text-xl font-eng focus:outline-none focus:ring-2 focus:ring-purple-300 border border-gray-200" placeholder="ë¬´ì—‡ì„ (my friend)" oninput="updateL2()">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-purple-500 to-pink-500 p-1.5 rounded-[2rem] shadow-xl mt-4">
                    <div class="bg-white rounded-[1.7rem] p-6 text-center">
                        <p class="text-sm text-gray-400 mb-2 font-hand font-bold">ì§€ê¸ˆê¹Œì§€ ì™„ì„±ëœ ë¬¸ì¥</p>
                        <p id="l2-result" class="font-eng text-3xl mb-6 text-gray-800 font-bold leading-relaxed break-words">...</p>
                        <button onclick="speakL2()" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-700 py-4 rounded-2xl font-bold transition flex items-center justify-center gap-3 text-xl shadow-md transform active:scale-95">
                            <i id="icon-vol-2" class="fa-solid fa-volume-high"></i> Listen (ë“¤ì–´ë³´ê¸°)
                        </button>
                    </div>
                </div>
            </div>

            <div id="tab-3" class="tab-content space-y-8">
                <div class="text-center">
                    <span class="bg-indigo-100 text-indigo-600 px-4 py-1.5 rounded-full text-sm font-bold font-eng">Step 3</span>
                    <h3 class="text-3xl font-bold text-gray-700 font-hand mt-2">ë” ìì„¸í•˜ê²Œ ë§í•˜ê¸°</h3>
                </div>
                
                <div class="bg-indigo-50 p-6 rounded-[2rem] border-4 border-indigo-100 space-y-6 shadow-inner">
                    <div class="relative bg-white p-4 rounded-2xl border-2 border-indigo-200 shadow-sm">
                        <span class="absolute -top-3 left-6 bg-indigo-100 text-indigo-600 text-xs px-2 py-1 rounded font-bold font-eng">ê¸°ë³¸ ë¬¸ì¥ (Step 2)</span>
                        <input type="text" id="l3-base" class="w-full text-center font-eng text-2xl text-indigo-900 bg-transparent border-none focus:outline-none" placeholder="I feel happy because I met my friend" readonly>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex items-center gap-4 bg-white p-4 rounded-2xl shadow-sm border-2 border-transparent focus-within:border-indigo-300 transition">
                            <span class="text-xs font-bold bg-indigo-100 text-indigo-600 px-3 py-1.5 rounded-lg w-20 text-center">Where</span>
                            <input type="text" id="l3-where" class="flex-1 font-eng focus:outline-none text-2xl text-gray-700 placeholder-gray-300" placeholder="ì–´ë””ì„œ? (at school)" oninput="updateL3()">
                        </div>
                        <div class="flex items-center gap-4 bg-white p-4 rounded-2xl shadow-sm border-2 border-transparent focus-within:border-pink-300 transition">
                            <span class="text-xs font-bold bg-pink-100 text-pink-600 px-3 py-1.5 rounded-lg w-20 text-center">How</span>
                            <input type="text" id="l3-how" class="flex-1 font-eng focus:outline-none text-2xl text-gray-700 placeholder-gray-300" placeholder="ì–´ë–»ê²Œ? (happily)" oninput="updateL3()">
                        </div>
                        <div class="flex items-center gap-4 bg-white p-4 rounded-2xl shadow-sm border-2 border-transparent focus-within:border-yellow-300 transition">
                            <span class="text-xs font-bold bg-yellow-100 text-yellow-600 px-3 py-1.5 rounded-lg w-20 text-center">When</span>
                            <input type="text" id="l3-when" class="flex-1 font-eng focus:outline-none text-2xl text-gray-700 placeholder-gray-300" placeholder="ì–¸ì œ? (everyday)" oninput="updateL3()">
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-indigo-500 to-blue-500 p-1.5 rounded-[2rem] shadow-xl mt-4">
                    <div class="bg-white rounded-[1.7rem] p-6 text-center">
                        <p class="text-sm text-gray-400 mb-2 font-hand font-bold">ì™„ì„±ëœ ë¬¸ì¥</p>
                        <p id="l3-result" class="font-eng text-3xl mb-6 text-gray-800 font-bold leading-relaxed break-words">...</p>
                        <div class="flex gap-3">
                            <button onclick="addToStory(3)" class="flex-1 bg-white hover:bg-gray-50 border-2 text-gray-600 py-4 rounded-2xl font-bold shadow-sm transition flex items-center justify-center gap-2 transform active:scale-95 text-lg">
                                <i class="fa-solid fa-download"></i> ë°”ë¡œ ì €ì¥
                            </button>
                            <button onclick="goToLevelUp()" class="flex-[2] bg-purple-500 hover:bg-purple-600 text-white py-4 rounded-2xl font-bold shadow-md transition flex items-center justify-center gap-2 transform active:scale-95 text-lg border-b-4 border-purple-700 active:border-b-0 active:translate-y-1">
                                <i class="fa-solid fa-arrow-up-right-dots"></i> 4ë‹¨ê³„: ë ˆë²¨ì—…!
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">* ì €ì¥í•˜ë©´ 5ë‹¨ê³„ë¡œ ë¬¸ì¥ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>

            <div id="tab-4" class="tab-content space-y-8">
                <div class="text-center">
                    <span class="bg-purple-100 text-purple-700 px-4 py-1.5 rounded-full text-sm font-bold font-eng">Step 4</span>
                    <h3 class="text-3xl font-bold text-gray-700 font-hand mt-2">ì‹¬í™”: ë¬¸ì¥ ì—…ê·¸ë ˆì´ë“œ</h3>
                    <p class="text-sm text-gray-400 mt-1">ê´€ê³„ëŒ€ëª…ì‚¬(who/which)ë‚˜ toë¥¼ ì¨ë³´ì„¸ìš”!</p>
                </div>

                <div class="bg-purple-50 p-6 rounded-[2rem] border-2 border-purple-200 shadow-inner">
                    <label class="text-sm font-bold text-purple-700 block mb-3 ml-2"><i class="fa-solid fa-pen-nib mr-2"></i> ë‚˜ì˜ ë¬¸ì¥ ìˆ˜ì •í•˜ê¸° (Editor)</label>
                    <textarea id="l4-input" class="w-full h-48 p-5 rounded-3xl border-4 border-purple-200 focus:border-purple-500 focus:ring-0 font-eng text-3xl text-gray-800 resize-none leading-relaxed shadow-sm bg-white" placeholder="3ë‹¨ê³„ì—ì„œ ë§Œë“  ë¬¸ì¥ì´ ì—¬ê¸°ì— ë‚˜ì˜µë‹ˆë‹¤."></textarea>
                    
                    <div class="flex gap-3 mt-4 overflow-x-auto pb-2 hide-scrollbar">
                        <button onclick="insertText(' who ')" class="px-4 py-2 bg-white border-2 border-purple-200 rounded-xl text-sm font-bold text-purple-600 hover:bg-purple-100 flex-shrink-0 shadow-sm">+ who</button>
                        <button onclick="insertText(' which ')" class="px-4 py-2 bg-white border-2 border-purple-200 rounded-xl text-sm font-bold text-purple-600 hover:bg-purple-100 flex-shrink-0 shadow-sm">+ which</button>
                        <button onclick="insertText(' to ')" class="px-4 py-2 bg-white border-2 border-purple-200 rounded-xl text-sm font-bold text-purple-600 hover:bg-purple-100 flex-shrink-0 shadow-sm">+ to</button>
                        <button onclick="insertText(' that ')" class="px-4 py-2 bg-white border-2 border-purple-200 rounded-xl text-sm font-bold text-purple-600 hover:bg-purple-100 flex-shrink-0 shadow-sm">+ that</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-3xl border border-gray-100 shadow-xl">
                    <button onclick="addToStory(4)" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-4 rounded-2xl font-bold shadow-lg transition flex items-center justify-center gap-3 transform active:scale-95 text-xl border-b-4 border-purple-800 active:border-b-0 active:translate-y-1">
                        <i class="fa-solid fa-check-circle"></i> ìˆ˜ì • ì™„ë£Œ & ì €ì¥í•˜ê¸°
                    </button>
                </div>
            </div>

            <div id="tab-5" class="tab-content space-y-8">
                <div class="text-center no-print">
                    <span class="bg-yellow-100 text-yellow-700 px-4 py-1.5 rounded-full text-sm font-bold font-eng">Step 5</span>
                    <h3 class="text-3xl font-bold text-gray-700 font-hand mt-2">ë‚˜ë§Œì˜ ì˜ì–´ ì´ì•¼ê¸°</h3>
                </div>

                <div class="bg-white p-8 rounded-[2.5rem] border-2 border-gray-200 shadow-lg min-h-[300px]">
                    <h4 class="text-sm font-bold text-gray-400 uppercase mb-4 flex justify-between items-center border-b pb-2">
                        <span>My English Story</span>
                        <span id="story-count" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full font-bold">0</span>
                    </h4>
                    
                    <ul id="story-list" class="space-y-4 mb-8">
                        <li class="text-center text-gray-400 text-lg py-16 italic no-print">
                            ì•„ì§ ì €ì¥ëœ ë¬¸ì¥ì´ ì—†ì–´ìš”.<br>3ë‹¨ê³„ë‚˜ 4ë‹¨ê³„ì—ì„œ 'ì €ì¥í•˜ê¸°'ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”!
                        </li>
                    </ul>

                    <div id="action-buttons" class="grid grid-cols-2 gap-4 mb-6 no-print hidden">
                        <button onclick="printPage()" class="bg-slate-700 hover:bg-slate-800 text-white py-4 rounded-2xl font-bold text-lg shadow-md flex items-center justify-center gap-2 transition hover:scale-[1.02]">
                            <i class="fa-solid fa-print"></i> ì¸ì‡„í•˜ê¸°
                        </button>
                        <button onclick="downloadTxt()" class="bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg shadow-md flex items-center justify-center gap-2 transition hover:scale-[1.02]">
                            <i class="fa-solid fa-file-arrow-down"></i> ì €ì¥í•˜ê¸°
                        </button>
                    </div>

                    <div id="ai-section" class="border-t-2 border-gray-100 pt-6 hidden no-print">
                        <button onclick="runAIGrammarCheck()" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-3 transition hover:scale-[1.02] text-xl">
                            <i class="fa-solid fa-wand-magic-sparkles text-white"></i> AI ì„ ìƒë‹˜ì˜ ì²¨ì‚­ (Polish)
                        </button>
                        
                        <div id="ai-result-box" class="mt-6 bg-yellow-50 rounded-3xl p-6 border-2 border-yellow-100 hidden">
                            <h5 class="text-sm font-bold text-yellow-800 mb-3 flex items-center">
                                <i class="fa-solid fa-robot mr-2"></i> AI's Feedback
                            </h5>
                            <p id="ai-text" class="font-eng text-2xl text-gray-700 leading-relaxed typing-cursor"></p>
                            <button onclick="copyAIResult()" class="mt-4 text-sm bg-white border border-gray-200 px-4 py-2 rounded-xl text-gray-500 hover:text-yellow-600 font-bold">
                                ë³µì‚¬í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="text-center py-6 bg-blue-50 text-blue-300 text-xs font-eng mt-4 rounded-t-[2.5rem] no-print">
            Designed by Park Seong-ae with EAIM
        </div>
    </div>

    <script>
        // --- ë°ì´í„° ---
        const VOCAB_DB = {
            "í•™êµ": "school", "ì¹œêµ¬": "friend", "ì„ ìƒë‹˜": "teacher", "ì‹œí—˜": "test", "ìˆ™ì œ": "homework",
            "ì ìˆ˜": "score", "ë°©í•™": "vacation", "ìˆ˜ì—…": "class", "ê¸‰ì‹": "lunch", 
            "ìš´ë™": "exercise", "ê²Œì„": "game", "ë…¸ë˜": "song", "ì¶¤": "dance",
            "ì—„ë§ˆ": "mom", "ì•„ë¹ ": "dad", "ê°€ì¡±": "family", "ì§‘": "home", "ë°¥": "meal",
            "ëˆ": "money", "ì„ ë¬¼": "gift", "ë‚ ì”¨": "weather", "ë¹„": "rain", "ëˆˆ": "snow",
            "ê°€ë‹¤": "go", "ì˜¤ë‹¤": "come", "ë¨¹ë‹¤": "eat", "ìë‹¤": "sleep", "ë†€ë‹¤": "play",
            "ê³µë¶€í•˜ë‹¤": "study", "ë§Œë‚˜ë‹¤": "meet", "ì´ì•¼ê¸°í•˜ë‹¤": "talk", "ì‚¬ë‘í•˜ë‹¤": "love",
            "ì‹«ì–´í•˜ë‹¤": "hate", "ì¢‹ì•„í•˜ë‹¤": "like", "ìš¸ë‹¤": "cry", "ì›ƒë‹¤": "laugh",
            "í–‰ë³µí•œ": "happy", "ìŠ¬í”ˆ": "sad", "í™”ë‚œ": "angry", "ë°°ê³ í”ˆ": "hungry",
            "í”¼ê³¤í•œ": "tired", "ì˜ˆìœ": "pretty", "ë©‹ì§„": "cool", "ì°©í•œ": "kind", "ë°”ìœ": "busy"
        };
        
        const EMOTIONS = [
            { color: '#FFD93D', name: 'Happy', ko: 'í–‰ë³µí•œ', emoji: 'ğŸ˜Š' },
            { color: '#FF6B6B', name: 'Angry', ko: 'í™”ë‚œ', emoji: 'ğŸ˜¡' },
            { color: '#4D96FF', name: 'Sad', ko: 'ìŠ¬í”ˆ', emoji: 'ğŸ˜­' },
            { color: '#6BCB77', name: 'Calm', ko: 'ì°¨ë¶„í•œ', emoji: 'ğŸ˜Œ' },
            { color: '#FFAD60', name: 'Excited', ko: 'ì‹ ë‚˜ëŠ”', emoji: 'ğŸ˜†' },
            { color: '#9CA3AF', name: 'Bored', ko: 'ì§€ë£¨í•œ', emoji: 'ğŸ˜‘' },
            { color: '#9D84B7', name: 'Scared', ko: 'ë¬´ì„œìš´', emoji: 'ğŸ˜±' },
            { color: '#F472B6', name: 'Lovely', ko: 'ì‚¬ë‘ìŠ¤ëŸ¬ìš´', emoji: 'ğŸ˜' },
            { color: '#87CEEB', name: 'Free', ko: 'ììœ ë¡œìš´', emoji: 'ğŸ•Šï¸' },
            { color: '#1F2937', name: 'Tired', ko: 'í”¼ê³¤í•œ', emoji: 'ğŸ˜«' }
        ];

        const ACTIONS = [
            { en: 'feel', ko: 'ëŠë¼ë‹¤', emoji: 'ğŸ˜Œ' },
            { en: 'like', ko: 'ì¢‹ì•„í•˜ë‹¤', emoji: 'â¤ï¸' },
            { en: 'eat', ko: 'ë¨¹ë‹¤', emoji: 'ğŸ”' },
            { en: 'play', ko: 'ë†€ë‹¤', emoji: 'ğŸ®' },
            { en: 'study', ko: 'ê³µë¶€í•˜ë‹¤', emoji: 'ğŸ“š' },
            { en: 'go', ko: 'ê°€ë‹¤', emoji: 'ğŸƒ' },
            { en: 'watch', ko: 'ë³´ë‹¤', emoji: 'ğŸ“º' },
            { en: 'meet', ko: 'ë§Œë‚˜ë‹¤', emoji: 'ğŸ¤' },
            { en: 'want', ko: 'ì›í•˜ë‹¤', emoji: 'â­' },
            { en: 'am', ko: 'ì´ë‹¤(be)', emoji: 'ğŸ˜' }
        ];

        let currentConn = 'because';
        let sentenceHistory = [];
        let voices = [];
        let englishVoice = null;

        // --- ì´ˆê¸°í™” (í•µì‹¬: ì†Œë¦¬ ë¯¸ë¦¬ ì¤€ë¹„í•˜ê¸°) ---
        window.onload = function() {
            renderEmotions();
            renderActions();
            updateL1(); updateL2(); updateL3();
            
            // 1. ì†Œë¦¬ ê¸°ëŠ¥ ì˜ˆì—´ (ì¤‘ìš”)
            if (window.speechSynthesis) {
                // ì•„ë¬´ ì†Œë¦¬ë„ ì•ˆ ë‚˜ëŠ” ë¹ˆ ë¬¸ì¥ì„ ì¬ìƒí•´ì„œ ì—”ì§„ì„ ê¹¨ì›€
                window.speechSynthesis.cancel();
                window.speechSynthesis.resume();
            }

            // 2. ëª©ì†Œë¦¬ ì°¾ê¸°
            loadVoices();
            if (window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = loadVoices;
            }
        };

        function loadVoices() {
            voices = window.speechSynthesis.getVoices();
            // ì˜ì–´ ëª©ì†Œë¦¬ ë¯¸ë¦¬ ì°¾ì•„ë†“ê¸° (ë§¤ë²ˆ ì°¾ìœ¼ë©´ ëŠë¦¼)
            englishVoice = voices.find(v => v.lang.includes('en-US') || v.name.includes('Google US English')) 
                        || voices.find(v => v.lang.includes('en'))
                        || null;
        }

        function renderEmotions() {
            const list = document.getElementById('emotion-list');
            list.innerHTML = "";
            EMOTIONS.forEach(emo => {
                const btn = document.createElement('button');
                btn.className = "card-btn w-20 h-24 rounded-2xl border-4 flex flex-col items-center justify-center shadow-sm transition-transform bg-white";
                btn.style.borderColor = emo.color;
                btn.innerHTML = `<span class="text-3xl mb-1">${emo.emoji}</span><span class="text-xs font-bold font-eng text-gray-600">${emo.name}</span>`;
                btn.onclick = () => selectEmotion(emo);
                list.appendChild(btn);
            });
        }

        function renderActions() {
            const list = document.getElementById('action-list');
            list.innerHTML = "";
            ACTIONS.forEach(act => {
                const btn = document.createElement('button');
                btn.className = "card-btn w-20 h-20 rounded-2xl border-4 border-yellow-300 flex flex-col items-center justify-center shadow-sm bg-white hover:bg-yellow-50";
                btn.innerHTML = `<span class="text-3xl">${act.emoji}</span><span class="text-xs font-bold font-eng text-gray-700">${act.en}</span>`;
                btn.onclick = () => {
                    document.getElementById('l1-action').value = act.en;
                    updateL1();
                };
                list.appendChild(btn);
            });
        }

        function selectEmotion(emo) {
            document.getElementById('selected-emotion-display').classList.remove('hidden');
            document.getElementById('emotion-text').innerText = `${emo.name} (${emo.ko})`;

            document.getElementById('l1-who').value = "I";
            document.getElementById('l1-action').value = "feel";
            document.getElementById('l1-what').value = emo.name;
            updateL1();
            
            switchTab(1);
        }

        document.getElementById('search-input').addEventListener('input', function(e) {
            const term = e.target.value.trim();
            const resultBox = document.getElementById('search-result-box');
            const naverBtn = document.getElementById('naver-btn');
            if (term.length > 0) {
                resultBox.classList.remove('hidden');
                naverBtn.classList.remove('hidden');
                naverBtn.onclick = () => window.open(`https://en.dict.naver.com/#/search?query=${term}`, '_blank');
                if (VOCAB_DB[term]) {
                    resultBox.innerHTML = `<span class="text-gray-300">${term}</span> ğŸ‘‰ <span class="text-yellow-400 font-bold font-eng text-2xl">${VOCAB_DB[term]}</span>`;
                } else {
                    resultBox.innerHTML = `<span class="text-gray-400 text-sm">ì•± ì‚¬ì „ì— ì—†ë„¤ìš”.<br>ì˜¤ë¥¸ìª½ 'ì‚¬ì „' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</span>`;
                }
            } else {
                resultBox.classList.add('hidden');
                naverBtn.classList.add('hidden');
            }
        });

        function switchTab(tabNum) {
            [1, 2, 3, 4, 5].forEach(i => {
                const btn = document.getElementById(`btn-tab-${i}`);
                const content = document.getElementById(`tab-${i}`);
                const commonTools = document.getElementById('common-tools');
                
                if(tabNum >= 4) commonTools.classList.add('hidden');
                else commonTools.classList.remove('hidden');

                if (i === tabNum) {
                    btn.classList.add('active'); btn.classList.remove('inactive');
                    if(i===1) { btn.style.backgroundColor = '#2563EB'; btn.style.borderColor = '#1E40AF'; }
                    else if(i===2) { btn.style.backgroundColor = '#9333EA'; btn.style.borderColor = '#7E22CE'; }
                    else if(i===3) { btn.style.backgroundColor = '#4F46E5'; btn.style.borderColor = '#4338CA'; }
                    else if(i===4) { btn.style.backgroundColor = '#7E22CE'; btn.style.borderColor = '#6B21A8'; btn.style.color='white'; }
                    else if(i===5) { btn.style.backgroundColor = '#CA8A04'; btn.style.borderColor = '#A16207'; btn.style.color='white'; }
                    content.classList.add('active');
                } else {
                    btn.classList.remove('active'); btn.classList.add('inactive');
                    btn.style.backgroundColor = 'white'; btn.style.borderColor = '#E5E7EB'; btn.style.color = '#6B7280';
                    if(i===4) { btn.style.backgroundColor = '#FAF5FF'; btn.style.borderColor = '#E9D5FF'; btn.style.color = '#7E22CE'; }
                    if(i===5) { btn.style.backgroundColor = '#FEFCE8'; btn.style.borderColor = '#FEF08A'; btn.style.color = '#A16207'; }
                    content.classList.remove('active');
                }
            });
        }

        function updateL1() {
            const w = document.getElementById('l1-who').value || '(Who)';
            const a = document.getElementById('l1-action').value || '(Action)';
            const t = document.getElementById('l1-what').value || '(State)';
            const res = `${w} ${a} ${t}`;
            document.getElementById('l1-result').innerText = res + ".";
            document.getElementById('l2-a').value = res;
            updateL2();
        }
        
        function updateL2() {
            const a = document.getElementById('l2-a').value || '...';
            const bw = document.getElementById('l2-b-who').value || '';
            const ba = document.getElementById('l2-b-action').value || '';
            const bt = document.getElementById('l2-b-what').value || '';
            let backSentence = '(Who+Action+What)';
            if (bw || ba || bt) { backSentence = `${bw} ${ba} ${bt}`.trim(); }
            const fullSentence = `${a} ${currentConn} ${backSentence}`;
            document.getElementById('l2-result').innerText = fullSentence + ".";
            document.getElementById('l3-base').value = fullSentence;
            updateL3();
        }
        
        function setConn(conn) {
            currentConn = conn;
            const btns = document.querySelectorAll('.conn-btn');
            btns.forEach(btn => {
                if(btn.innerText.includes(conn)) {
                    btn.className = "conn-btn px-4 py-2 rounded-xl text-base font-bold font-eng bg-purple-500 text-white shadow-md transform scale-105 transition-all border-b-4 border-purple-700 active:border-b-0 active:translate-y-1";
                } else {
                    btn.className = "conn-btn px-4 py-2 rounded-xl text-base font-bold font-eng bg-white text-gray-500 border-2 border-gray-300 hover:bg-gray-50 transition-all";
                }
            });
            updateL2();
        }
        
        function updateL3() {
            const base = document.getElementById('l3-base').value || '(Main)';
            const wh = document.getElementById('l3-where').value;
            const ho = document.getElementById('l3-how').value;
            const we = document.getElementById('l3-when').value;
            let res = base;
            if(wh) res += ` ${wh}`; if(ho) res += ` ${ho}`; if(we) res += ` ${we}`;
            document.getElementById('l3-result').innerText = res + ".";
        }

        function goToLevelUp() {
            const currentSent = document.getElementById('l3-result').innerText;
            if(!currentSent || currentSent.includes('...')) { alert("ë¬¸ì¥ì„ ë¨¼ì € ì™„ì„±í•´ì£¼ì„¸ìš”!"); return; }
            document.getElementById('l4-input').value = currentSent;
            switchTab(4);
        }
        
        function insertText(text) {
            const textarea = document.getElementById('l4-input');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const val = textarea.value;
            textarea.value = val.substring(0, start) + text + val.substring(end);
            textarea.focus();
            textarea.selectionStart = start + text.length;
            textarea.selectionEnd = start + text.length;
        }

        // ë¬¸ì¥ ì €ì¥ ë° ì´ˆê¸°í™”
        function addToStory(fromStep) {
            let finalSent = "";
            if (fromStep === 3) finalSent = document.getElementById('l3-result').innerText;
            if (fromStep === 4) finalSent = document.getElementById('l4-input').value;

            if(!finalSent || finalSent.includes('...')) { alert("ë¬¸ì¥ì„ ì™„ì„±í•´ì£¼ì„¸ìš”!"); return; }
            
            sentenceHistory.push(finalSent);
            renderStoryList();
            
            if(confirm("ë¬¸ì¥ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! \nìƒˆë¡œìš´ ë¬¸ì¥ì„ ë§Œë“¤ëŸ¬ ê°ˆê¹Œìš”?")) {
                // Clear inputs
                document.getElementById('l1-what').value = '';
                document.getElementById('l2-b-who').value = '';
                document.getElementById('l2-b-action').value = '';
                document.getElementById('l2-b-what').value = '';
                document.getElementById('l3-where').value = '';
                document.getElementById('l3-how').value = '';
                document.getElementById('l3-when').value = '';
                document.getElementById('l4-input').value = '';
                updateL1(); 
                switchTab(1);
            } else {
                switchTab(5); // Go to collection
            }
        }

        function renderStoryList() {
            const listEl = document.getElementById('story-list');
            const aiSection = document.getElementById('ai-section');
            const actionBtns = document.getElementById('action-buttons');
            const countEl = document.getElementById('story-count');
            
            countEl.innerText = sentenceHistory.length;
            
            if(sentenceHistory.length === 0) {
                listEl.innerHTML = `<li class="text-center text-gray-400 text-lg py-16 italic no-print">ì•„ì§ ì €ì¥ëœ ë¬¸ì¥ì´ ì—†ì–´ìš”.<br>3ë‹¨ê³„ë‚˜ 4ë‹¨ê³„ì—ì„œ 'ì €ì¥í•˜ê¸°'ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”!</li>`;
                aiSection.classList.add('hidden');
                actionBtns.classList.add('hidden');
                return;
            }

            aiSection.classList.remove('hidden');
            actionBtns.classList.remove('hidden');
            listEl.innerHTML = '';
            
            sentenceHistory.forEach((sent, idx) => {
                const li = document.createElement('li');
                li.className = "story-item bg-gray-50 p-5 rounded-2xl border-2 border-gray-200 text-gray-800 font-eng flex justify-between items-center group text-2xl shadow-sm";
                li.innerHTML = `
                    <span>${idx + 1}. ${sent}</span>
                    <button onclick="removeSentence(${idx})" class="no-print text-red-400 opacity-50 group-hover:opacity-100 hover:text-red-600 transition p-2">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                `;
                listEl.appendChild(li);
            });
        }

        function removeSentence(idx) {
            sentenceHistory.splice(idx, 1);
            renderStoryList();
        }

        function runAIGrammarCheck() {
            const aiBox = document.getElementById('ai-result-box');
            const aiText = document.getElementById('ai-text');
            aiBox.classList.remove('hidden');
            aiText.innerText = "AI ì„ ìƒë‹˜ì´ ìƒê° ì¤‘ì´ì—ìš”...";
            
            setTimeout(() => {
                let story = sentenceHistory.join(' ');
                story = "Here is your polished story:\n\n\"" + story + "\"\n\n(Great job using complex sentences! Keep it up!)";
                
                aiText.innerText = "";
                let i = 0;
                function typeWriter() {
                    if (i < story.length) {
                        aiText.innerText += story.charAt(i);
                        i++;
                        setTimeout(typeWriter, 30);
                    }
                }
                typeWriter();
            }, 1500);
        }

        function copyAIResult() {
            navigator.clipboard.writeText(document.getElementById('ai-text').innerText)
                .then(() => alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
        }

        // --- ì¸ì‡„ ê¸°ëŠ¥ ---
        function printPage() {
            window.print();
        }

        // --- íŒŒì¼ ì €ì¥ ê¸°ëŠ¥ ---
        function downloadTxt() {
            const text = sentenceHistory.join('\n');
            const blob = new Blob([text], { type: "text/plain" });
            const anchor = document.createElement("a");
            anchor.download = "My_English_Story.txt";
            anchor.href = window.URL.createObjectURL(blob);
            anchor.target = "_blank";
            anchor.style.display = "none";
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
        }

        // --- ì†Œë¦¬ ë“£ê¸° (ì¦‰ê° ë°˜ì‘ ë²„ì „) ---
        function speakText(text) {
            if(!text || text.includes('...')) { alert("ë¬¸ì¥ì„ ì™„ì„±í•´ì£¼ì„¸ìš”!"); return; }
            if (!window.speechSynthesis) { alert("ì†Œë¦¬ë¥¼ ë“¤ì„ ìˆ˜ ì—†ëŠ” í™˜ê²½ì…ë‹ˆë‹¤."); return; }

            // 1. ê¸°ì¡´ ì†Œë¦¬ ì¦‰ì‹œ ì¤‘ë‹¨
            window.speechSynthesis.cancel();
            
            // 2. ë°œí™” ê°ì²´ ìƒì„±
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'en-US'; 
            msg.rate = 0.9;
            
            // 3. ë¯¸ë¦¬ ì°¾ì•„ë‘” ëª©ì†Œë¦¬(englishVoice)ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ì ìš©
            // (ì—†ìœ¼ë©´ ë¸Œë¼ìš°ì € ê¸°ë³¸ê°’ ì‚¬ìš©)
            if(englishVoice) {
                msg.voice = englishVoice;
            } else if (voices.length > 0) {
                // í˜¹ì‹œ englishVoiceê°€ nullì´ë©´ ë‹¤ì‹œ ì°¾ê¸°
                const retryVoice = voices.find(v => v.lang.includes('en') || v.name.includes('English'));
                if (retryVoice) msg.voice = retryVoice;
            }

            // 4. ì¬ìƒ
            window.speechSynthesis.speak(msg);

            // ì•„ì´ì½˜ ì• ë‹ˆë©”ì´ì…˜
            let iconId = "";
            if(document.getElementById('tab-1').classList.contains('active')) iconId = "icon-vol-1";
            else if(document.getElementById('tab-2').classList.contains('active')) iconId = "icon-vol-2";
            
            if(iconId) {
                const icon = document.getElementById(iconId);
                icon.classList.add('speaking-icon');
                msg.onend = function() { icon.classList.remove('speaking-icon'); };
            }
        }
        function speakL1() { speakText(document.getElementById('l1-result').innerText); }
        function speakL2() { speakText(document.getElementById('l2-result').innerText); }
        
        function resetAll() {
            if(confirm("ëª¨ë“  ë‚´ìš©ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) location.reload();
        }
    </script>
</body>
</html>