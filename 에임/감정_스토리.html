<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì—ì„(EAIM) ê°ì • ìŠ¤í† ë¦¬</title>
    
    <!-- React & Tailwind CSS ë¡œë“œ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- í°íŠ¸ -->
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #F8FAFC; user-select: none; }
        .font-hand { font-family: 'Gaegu', cursive; }
        .canvas-container { touch-action: none; cursor: crosshair; } 
        input, textarea { user-select: text; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .typewriter {
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }
        
        /* ë‹¨ê³„ë³„ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .stage-badge-0 { background-color: #DBEAFE; color: #1E40AF; border: 1px solid #93C5FD; } /* ê¸° - íŒŒë‘ */
        .stage-badge-1 { background-color: #F3E8FF; color: #6B21A8; border: 1px solid #D8B4FE; } /* ìŠ¹ - ë³´ë¼ */
        .stage-badge-2 { background-color: #FCE7F3; color: #9D174D; border: 1px solid #F9A8D4; } /* ì „ - í•‘í¬/ë¹¨ê°• */
        .stage-badge-3 { background-color: #DCFCE7; color: #166534; border: 1px solid #86EFAC; } /* ê²° - ì´ˆë¡ */

        /* ë¬¸ì¥ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .sentence-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        .sentence-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .sentence-card:active {
            transform: scale(0.98);
            background-color: #F1F5F9;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const AimStudentApp = () => {
            const [step, setStep] = useState(1);
            const [emotionSequence, setEmotionSequence] = useState([]);
            const [tempColor, setTempColor] = useState(null);
            const [tempWord, setTempWord] = useState('');
            const [reasons, setReasons] = useState(['', '', '', '']);
            const [studentDraft, setStudentDraft] = useState(''); 
            const [finalStory, setFinalStory] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);

            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);

            // ê¸°ìŠ¹ì „ê²° ë°ì´í„°
            const STORY_STAGES = [
                { name: 'ê¸° (ì‹œì‘)', desc: 'ì´ì•¼ê¸°ì˜ ì‹œì‘', badgeClass: 'stage-badge-0', question: 'ì´ì•¼ê¸°ê°€ ì–´ë–»ê²Œ ì‹œì‘ë˜ì—ˆë‚˜ìš”? (ë°°ê²½, ìƒí™©)' },
                { name: 'ìŠ¹ (ì „ê°œ)', desc: 'ì‚¬ê±´ì˜ ë°œë‹¬', badgeClass: 'stage-badge-1', question: 'ì–´ë–¤ ì¼ì´ ìƒê²¨ì„œ ê¸°ë¶„ì´ ë³€í–ˆë‚˜ìš”?' },
                { name: 'ì „ (ì ˆì •)', desc: 'ê°€ì¥ ê°•ë ¬í•œ ìˆœê°„', badgeClass: 'stage-badge-2', question: 'ê°€ì¥ ë§ˆìŒì´ í¬ê²Œ ì›€ì§ì¸ ìˆœê°„ì€ ì–¸ì œì¸ê°€ìš”?' },
                { name: 'ê²° (ë§ˆë¬´ë¦¬)', desc: 'ì´ì•¼ê¸°ì˜ ë', badgeClass: 'stage-badge-3', question: 'ëª¨ë“  ì¼ì´ ëë‚˜ê³  ì–´ë–¤ ë§ˆìŒì´ ë‚¨ì•˜ë‚˜ìš”?' }
            ];

            // ë°ì´í„°: ìƒ‰ê¹” 15ê°€ì§€
            const colors = [
                { id: 'red', code: '#EF4444', name: 'ì—´ì •/í™”ë‚¨' },
                { id: 'orange', code: '#F97316', name: 'í™œê¸°/ê¸´ì¥' },
                { id: 'yellow', code: '#F59E0B', name: 'ê¸°ì¨/í¬ë§' },
                { id: 'green', code: '#10B981', name: 'í¸ì•ˆ/ì„±ì¥' },
                { id: 'mint', code: '#14B8A6', name: 'ìƒì¾Œ/ìƒˆë¡œì›€' },
                { id: 'sky', code: '#0EA5E9', name: 'ììœ /ê°€ë²¼ì›€' },
                { id: 'blue', code: '#3B82F6', name: 'ìŠ¬í””/ì°¨ë¶„' },
                { id: 'navy', code: '#1E3A8A', name: 'ê¹Šì€ìŠ¬í””/ì§€í˜œ' },
                { id: 'purple', code: '#8B5CF6', name: 'ë¶ˆì•ˆ/ì‹ ë¹„' },
                { id: 'pink', code: '#EC4899', name: 'ì‚¬ë‘/ì„¤ë ˜' },
                { id: 'gold', code: '#EAB308', name: 'ìì‹ ê°/ìµœê³ ' },
                { id: 'brown', code: '#78350F', name: 'ë‹µë‹µ/ë¬´ê±°ì›€' },
                { id: 'grey', code: '#64748B', name: 'ì§€ë£¨/ë¬´ê´€ì‹¬' },
                { id: 'black', code: '#1F2937', name: 'ë‘ë ¤ì›€/ë§‰ë§‰' },
                { id: 'white', code: '#FFFFFF', name: 'ë©í•¨/í•˜ì–˜ì§' },
            ];

            const words = [
                'í–‰ë³µí•œ', 'ê¸°ìœ', 'ì‹ ë‚˜ëŠ”', 'ì¦ê±°ìš´', 'ì§œë¦¿í•œ', 'í™©í™€í•œ', 
                'ê°ë™ì ì¸', 'ë¿Œë“¯í•œ', 'ìë‘ìŠ¤ëŸ¬ìš´', 'ìì‹ ë§Œë§Œí•œ', 'í†µì¾Œí•œ',
                'ê°ì‚¬í•œ', 'ì‚¬ë‘ìŠ¤ëŸ¬ìš´', 'ì„¤ë ˆëŠ”', 'ê¸°ëŒ€ë˜ëŠ”', 'ìƒì¾Œí•œ', 
                'í›„ë ¨í•œ', 'ììœ ë¡œìš´', 'í¸ì•ˆí•œ', 'í¬ê·¼í•œ', 'ë“ ë“ í•œ',
                'í‰ì˜¨í•œ', 'ì°¨ë¶„í•œ', 'ë‹¤ì •í•œ', 'ì¹œê·¼í•œ', 'ì‹ ê¸°í•œ', 'ê¶ê¸ˆí•œ', 
                'ë†€ë¼ìš´', 'í¥ë¯¸ë¡œìš´', 'ì¬ë¯¸ìˆëŠ”', 'ìŠ¬í”ˆ', 'ìš°ìš¸í•œ', 'ì†ìƒí•œ', 
                'ì„œìš´í•œ', 'ì‹¤ë§í•œ', 'í—ˆì „í•œ', 'ì“¸ì“¸í•œ', 'ì™¸ë¡œìš´', 'ë¹„ì°¸í•œ', 
                'ê´´ë¡œìš´', 'ë¬´ê¸°ë ¥í•œ', 'ì§€ì¹œ', 'í™”ê°€ ë‚œ', 'ì§œì¦ë‚˜ëŠ”', 'ë‹µë‹µí•œ', 
                'ì–µìš¸í•œ', 'ë¶„í•œ', 'ì–„ë¯¸ìš´', 'ë¯¸ìš´', 'ë¶ˆì¾Œí•œ', 'ì„±ê°€ì‹ ', 
                'ì§ˆíˆ¬ë‚˜ëŠ”', 'ë¬´ì„œìš´', 'ë‘ë ¤ìš´', 'ê²ë‚˜ëŠ”', 'ë¶ˆì•ˆí•œ', 'ê¸´ì¥ë˜ëŠ”', 
                'ì¡°ë§ˆì¡°ë§ˆí•œ', 'ë‹¹í™©ìŠ¤ëŸ¬ìš´', 'í˜¼ë€ìŠ¤ëŸ¬ìš´', 'ë§‰ë§‰í•œ', 'ë¶€ë„ëŸ¬ìš´', 
                'ì°½í”¼í•œ', 'ë¯¸ì•ˆí•œ', 'ì£„ì†¡í•œ', 'í›„íšŒë˜ëŠ”', 'ì§€ë£¨í•œ', 'ì‹¬ì‹¬í•œ', 
                'ê·€ì°®ì€', 'í”¼ê³¤í•œ', 'ë©í•œ'
            ];

            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            useEffect(() => {
                if (step === 1 && canvasRef.current) {
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');
                    const parent = canvas.parentElement;
                    canvas.width = parent.offsetWidth;
                    canvas.height = 250;
                    
                    ctx.strokeStyle = '#E2E8F0'; ctx.lineWidth = 1; ctx.beginPath();
                    ctx.moveTo(0, 125); ctx.lineTo(canvas.width, 125);
                    for(let i=1; i<4; i++) { ctx.moveTo(canvas.width * (i/4), 0); ctx.lineTo(canvas.width * (i/4), 250); }
                    ctx.stroke();
                    
                    ctx.font = '12px Gaegu'; ctx.fillStyle = '#94A3B8'; ctx.textAlign = 'center';
                    const labels = ['ê¸°(ì‹œì‘)', 'ìŠ¹(ì „ê°œ)', 'ì „(ì ˆì •)', 'ê²°(ë)'];
                    for(let i=0; i<4; i++) { ctx.fillText(labels[i], (canvas.width * (i/4)) + (canvas.width/8), 240); }
                }
            }, [step]);

            const getPos = (e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };
            const startDrawing = (e) => {
                setIsDrawing(true); const pos = getPos(e); const ctx = canvasRef.current.getContext('2d');
                ctx.beginPath(); ctx.moveTo(pos.x, pos.y); ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#4F46E5';
            };
            const draw = (e) => {
                if (!isDrawing) return; const pos = getPos(e); const ctx = canvasRef.current.getContext('2d');
                ctx.lineTo(pos.x, pos.y); ctx.stroke();
            };
            const endDrawing = () => setIsDrawing(false);
            const clearCanvas = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = '#E2E8F0'; ctx.lineWidth = 1; ctx.beginPath();
                ctx.moveTo(0, 125); ctx.lineTo(canvas.width, 125);
                for(let i=1; i<4; i++) { ctx.moveTo(canvas.width * (i/4), 0); ctx.lineTo(canvas.width * (i/4), 250); }
                ctx.stroke();
                ctx.font = '12px Gaegu'; ctx.fillStyle = '#94A3B8'; ctx.textAlign = 'center';
                const labels = ['ê¸°(ì‹œì‘)', 'ìŠ¹(ì „ê°œ)', 'ì „(ì ˆì •)', 'ê²°(ë)'];
                for(let i=0; i<4; i++) { ctx.fillText(labels[i], (canvas.width * (i/4)) + (canvas.width/8), 240); }
            };

            const addEmotion = () => {
                if (!tempColor || !tempWord) return;
                if (emotionSequence.length >= 4) return;
                setEmotionSequence([...emotionSequence, { color: tempColor, word: tempWord, id: Date.now() }]);
                setTempColor(null); setTempWord('');
            };
            const removeEmotion = (index) => {
                const newSeq = emotionSequence.filter((_, i) => i !== index);
                setEmotionSequence(newSeq);
            };
            const updateReason = (index, text) => {
                const newReasons = [...reasons];
                newReasons[index] = text;
                setReasons(newReasons);
            };
            
            // Step 4: Drafting (Manual Insert Mode - ìˆ˜ì •ë¨)
            const prepareDraft = () => {
                // ìë™ ì±„ìš°ê¸° ì œê±° (ë¹ˆ ìƒíƒœë¡œ ì‹œì‘)
                setStep(4);
            };
            
            // ë°”ë¡œ ê¸€ì“°ê¸° ëª¨ë“œ (Skip to Step 4)
            const skipToDraft = () => {
                if(confirm("1~3ë‹¨ê³„ë¥¼ ê±´ë„ˆë›°ê³  ë°”ë¡œ ê¸€ì“°ê¸°ë¡œ ì´ë™í• ê¹Œìš”?")) {
                    setStep(4);
                }
            };

            const insertText = (text) => {
                const textarea = document.getElementById('student-draft');
                if (!textarea) return;
                
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const val = studentDraft;
                
                // í…ìŠ¤íŠ¸ ì‚½ì…
                const newVal = val.substring(0, start) + text + val.substring(end);
                setStudentDraft(newVal);
                
                // í¬ì»¤ìŠ¤ ìœ ì§€ ë° ì»¤ì„œ ì´ë™
                setTimeout(() => {
                    textarea.focus();
                    textarea.selectionStart = start + text.length;
                    textarea.selectionEnd = start + text.length;
                }, 0);
            };

            const handleReset = () => {
                if (window.confirm("ì •ë§ ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°ˆê¹Œìš”? ëª¨ë“  ë‚´ìš©ì´ ì§€ì›Œì ¸ìš”.")) {
                    setStep(1); setEmotionSequence([]); setReasons(['', '', '', '']); setTempColor(null); setTempWord(''); setFinalStory(''); setStudentDraft('');
                }
            };

            const generateAiStory = () => {
                setIsAnalyzing(true);
                setStep(5);
                setTimeout(() => {
                    let story = `[ ğŸ“œ ì—ì„(EAIM) AI ì‘ê°€ì˜ ì²¨ì‚­ ë…¸íŠ¸ ]\n\n`;
                    story += `ì‘ê°€ë‹˜(í•™ìƒ)ì´ ì‘ì„±í•œ ê¸€ì„ ë°”íƒ•ìœ¼ë¡œ ë” ë©‹ì§€ê²Œ ë‹¤ë“¬ì–´ ë³´ì•˜ì–´ìš”.\n\n`;
                    story += `----------------------------\n\n`;
                    
                    const text = studentDraft.trim();
                    if (text) {
                        story += text; // í•™ìƒ ê¸€ì„ ê¸°ë³¸ìœ¼ë¡œ
                        story += `\n\n(AIê°€ ë¬¸ë§¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°í•˜ê³ , ê°ì • í‘œí˜„ì„ ë” í’ë¶€í•˜ê²Œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.)`;
                    } else {
                        story += "(ì‘ì„±ëœ ë‚´ìš©ì´ ì—†ì–´ìš”. 4ë‹¨ê³„ì—ì„œ ê¸€ì„ ì¨ì£¼ì„¸ìš”!)";
                    }

                    story += `\n\n----------------------------\n`;
                    story += `ğŸŒŸ ì„ ìƒë‹˜ì˜ í•œë§ˆë””: ìŠ¤ìŠ¤ë¡œ ë¬¸ì¥ì„ ì—°ê²°í•´ì„œ ì™„ì„±í•œ ì ì´ ì •ë§ í›Œë¥­í•´ìš”! \nì´ìœ ì™€ ê°ì •ì´ ì˜ ì–´ìš°ëŸ¬ì§„ ë©‹ì§„ ê¸€ì…ë‹ˆë‹¤.`;
                    
                    setFinalStory(story);
                    setIsAnalyzing(false);
                }, 2000);
            };

            const copyToClipboard = () => {
                navigator.clipboard.writeText(finalStory)
                    .then(() => alert("ì¼ê¸° ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆì–´ìš”!\nì„ ìƒë‹˜ íŒ¨ë“¤ë ›ì´ë‚˜ ì¹´í†¡ì— 'ë¶™ì—¬ë„£ê¸°' í•˜ì„¸ìš”. ğŸ‘"))
                    .catch(err => alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆì–´ìš” ã… ã… "));
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-2xl flex flex-col relative">
                    {/* Header */}
                    <header className="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 text-white flex justify-between items-center sticky top-0 z-30 shadow-lg rounded-b-2xl">
                        <div className="flex items-center gap-2">
                            <span className="bg-white/20 p-1.5 rounded-lg text-lg">ğŸµ</span>
                            <h1 className="text-lg font-bold">EAIM ê°ì • ìŠ¤í† ë¦¬</h1>
                        </div>
                        <div className="text-xs bg-white/20 px-3 py-1 rounded-full font-bold backdrop-blur-sm">
                            Step {step} / 5
                        </div>
                    </header>

                    <main className="flex-grow p-6 flex flex-col items-center overflow-y-auto pb-32">
                        {step === 1 && (
                            <div className="w-full flex flex-col gap-6 animate-fade-in">
                                <div className="text-center">
                                    <h2 className="text-xl font-bold text-gray-800 font-hand">ê°ì • ê·¸ë˜í”„ ê·¸ë¦¬ê¸° ğŸ“‰</h2>
                                    <p className="text-sm text-gray-500 mt-1">
                                        <span className="font-bold text-indigo-500">ê¸°-ìŠ¹-ì „-ê²°</span> íë¦„ì— ë”°ë¼ ê·¸ë ¤ë³´ì„¸ìš”.
                                    </p>
                                </div>
                                <div className="border-2 border-gray-200 rounded-2xl bg-white relative canvas-container h-[250px] shadow-inner overflow-hidden">
                                    <div className="absolute left-3 top-3 text-[10px] text-gray-400 font-bold bg-gray-100 px-2 py-1 rounded-full">High</div>
                                    <div className="absolute left-3 bottom-3 text-[10px] text-gray-400 font-bold bg-gray-100 px-2 py-1 rounded-full">Low</div>
                                    <canvas ref={canvasRef} className="w-full h-full touch-none"
                                        onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={endDrawing} onMouseLeave={endDrawing}
                                        onTouchStart={startDrawing} onTouchMove={draw} onTouchEnd={endDrawing}
                                    />
                                </div>
                                <div className="flex flex-col gap-2">
                                    <div className="flex gap-2">
                                        <button onClick={clearCanvas} className="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200 transition">ì§€ìš°ê¸°</button>
                                        <button onClick={() => setStep(2)} className="flex-[2] bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition transform active:scale-95">ë‹¤ìŒ ë‹¨ê³„ ğŸ‘‰</button>
                                    </div>
                                    <button onClick={skipToDraft} className="w-full bg-white border border-indigo-200 text-indigo-500 py-2 rounded-xl text-sm font-bold hover:bg-indigo-50 transition">
                                        â© ê·¸ë˜í”„ ì—†ì´ ë°”ë¡œ ê¸€ì“°ê¸° (Skip)
                                    </button>
                                </div>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="w-full flex flex-col gap-6 animate-fade-in">
                                <div className="text-center">
                                    <h2 className="text-xl font-bold text-gray-800 font-hand">ê¸°ìŠ¹ì „ê²° ì±„ìš°ê¸° ğŸ§©</h2>
                                    <p className="text-sm text-gray-500 mt-1">ê° ë‹¨ê³„ì— ì–´ìš¸ë¦¬ëŠ” ë§ˆìŒì„ ë‹´ì•„ì£¼ì„¸ìš”.</p>
                                </div>
                                {/* Selected List */}
                                <div className="bg-white rounded-2xl border-2 border-indigo-100 min-h-[140px] shadow-sm overflow-hidden">
                                    <div className="bg-indigo-50 px-4 py-2 border-b border-indigo-100 flex justify-between items-center">
                                        <h4 className="text-xs font-bold text-indigo-800 uppercase">My Story Flow</h4>
                                        <span className="text-xs bg-white px-2 py-0.5 rounded-full text-indigo-500 font-bold">{emotionSequence.length}/4</span>
                                    </div>
                                    <div className="p-4 grid grid-cols-4 gap-2">
                                        {[0, 1, 2, 3].map((idx) => {
                                            const item = emotionSequence[idx];
                                            const stage = STORY_STAGES[idx];
                                            return (
                                                <div key={idx} className="flex flex-col items-center gap-1">
                                                    <div className={`text-[10px] font-bold px-2 py-0.5 rounded-full w-full text-center ${stage.badgeClass}`}>{stage.name.split(' ')[0]}</div>
                                                    {item ? (
                                                        <div className="animate-pop relative bg-white border-2 rounded-xl p-1 flex flex-col items-center w-full aspect-square justify-center shadow-sm" style={{borderColor: item.color.code}}>
                                                            <div className="w-4 h-4 rounded-full mb-1 border border-gray-100" style={{backgroundColor: item.color.code}}></div>
                                                            <span className="text-[10px] font-bold truncate w-full text-center text-gray-700">{item.word}</span>
                                                            <button onClick={() => removeEmotion(idx)} className="absolute -top-1.5 -right-1.5 bg-gray-400 text-white rounded-full w-4 h-4 flex items-center justify-center text-[8px] shadow-sm hover:bg-red-500">âœ•</button>
                                                        </div>
                                                    ) : (
                                                        <div className="w-full aspect-square border-2 border-dashed border-gray-200 rounded-xl flex items-center justify-center text-gray-300 text-lg bg-gray-50">{idx + 1}</div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                {/* Selection Area */}
                                <div className="space-y-5 bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                    <div className="text-center text-sm font-bold text-indigo-600 mb-2">
                                        {emotionSequence.length < 4 ? `ğŸ“¢ [${STORY_STAGES[emotionSequence.length].name}] ë‹¨ê³„ì˜ˆìš”!` : "ğŸ‰ ëª¨ë“  ë‹¨ê³„ê°€ ì±„ì›Œì¡Œì–´ìš”!"}
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 mb-2 block uppercase flex items-center">1. Color {tempColor && <span className="ml-auto text-indigo-600 bg-indigo-50 px-2 rounded-full">âœ” {tempColor.name}</span>}</label>
                                        <div className="grid grid-cols-5 gap-2.5">
                                            {colors.map((c) => (
                                                <button key={c.id} onClick={() => setTempColor(c)} className={`h-10 rounded-xl shadow-sm border-2 transition-all duration-200 ${tempColor?.id === c.id ? 'border-gray-800 scale-110 z-10 ring-2 ring-offset-1 ring-gray-300' : 'border-transparent opacity-90 hover:opacity-100 hover:scale-105'}`} style={{ backgroundColor: c.code }}></button>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 mb-2 block uppercase flex items-center">2. Word {tempWord && <span className="ml-auto text-indigo-600 bg-indigo-50 px-2 rounded-full">âœ” {tempWord}</span>}</label>
                                        <div className="bg-gray-50 p-3 rounded-2xl border border-gray-200 h-32 overflow-y-auto hide-scrollbar shadow-inner">
                                            <div className="flex flex-wrap gap-2 justify-center">
                                                {words.map((w) => (
                                                    <button key={w} onClick={() => setTempWord(w)} className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-all ${tempWord === w ? 'bg-indigo-600 border-indigo-600 text-white shadow-md transform scale-105' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-100'}`} >{w}</button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    <button onClick={addEmotion} disabled={!tempColor || !tempWord || emotionSequence.length >= 4} className={`w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all duration-300 shadow-md ${(!tempColor || !tempWord || emotionSequence.length >= 4) ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-gray-900 text-white hover:bg-black hover:scale-[1.02]'}`}>
                                        {emotionSequence.length >= 4 ? "4ê°œ ëª¨ë‘ ë‹´ì•˜ì–´ìš”!" : (!tempColor || !tempWord) ? "ìƒ‰ê¹”ê³¼ ë‹¨ì–´ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”" : <span>ë‹´ê¸° <span className="ml-1 text-yellow-300">ğŸ“¥</span></span>}
                                    </button>
                                </div>
                            </div>
                        )}

                        {step === 3 && (
                            <div className="w-full flex flex-col gap-6 animate-fade-in pb-10">
                                <div className="text-center">
                                    <h2 className="text-xl font-bold text-gray-800 font-hand">ì´ì•¼ê¸° ì—°ê²°í•˜ê¸°âœï¸</h2>
                                    <p className="text-sm text-gray-500 mt-1">ê° ë‹¨ê³„ì˜ ì§ˆë¬¸ì— ë‹µí•˜ë©° ë¬¸ì¥ì„ ì´ì–´ë³´ì„¸ìš”.</p>
                                </div>
                                <div className="w-full bg-white border border-gray-200 rounded-2xl p-5 shadow-lg relative">
                                    <div className="space-y-8 mt-2">
                                        {emotionSequence.map((item, idx) => {
                                            const stage = STORY_STAGES[idx];
                                            return (
                                                <div key={item.id} className="relative pl-6 border-l-2 border-dashed border-gray-200 pb-6 last:pb-0 last:border-0">
                                                    <div className={`absolute -left-[14px] top-0 w-7 h-7 rounded-full flex items-center justify-center text-[10px] font-bold border-2 border-white shadow-sm ${stage.badgeClass}`}>{stage.name.charAt(0)}</div>
                                                    <div className="flex flex-col gap-2">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xs font-bold text-gray-600">{stage.name}</span>
                                                            <div className="px-2 py-0.5 rounded-md text-white font-bold text-[10px] shadow-sm flex items-center gap-1" style={{ backgroundColor: item.color.code, color: item.color.id === 'white' ? 'black' : 'white' }}>{item.word}</div>
                                                        </div>
                                                        <div className="text-xs text-indigo-500 font-bold bg-indigo-50 p-2 rounded-lg mb-1">ğŸ’¡ {stage.question}</div>
                                                        <div className="bg-white rounded-xl p-3 border border-gray-200 focus-within:border-indigo-400 focus-within:ring-2 focus-within:ring-indigo-100 transition-all shadow-sm">
                                                            <textarea className="w-full font-hand text-lg bg-transparent focus:outline-none resize-none placeholder-gray-300 leading-normal text-gray-700" rows="2" placeholder="ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”..." value={reasons[idx]} onChange={(e) => updateReason(idx, e.target.value)}></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                <div className="flex gap-3 w-full">
                                    <button onClick={() => setStep(2)} className="flex-1 bg-white border border-gray-200 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-50 transition">ë’¤ë¡œ</button>
                                    <button onClick={prepareDraft} className="flex-[2] bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition transform active:scale-95">ë‹¤ìŒ ë‹¨ê³„ (ê¸€ì§“ê¸°) ğŸ‘‰</button>
                                </div>
                            </div>
                        )}

                        {step === 4 && (
                            <div className="w-full flex flex-col gap-6 animate-fade-in pb-10">
                                <div className="text-center">
                                    <h2 className="text-xl font-bold text-gray-800 font-hand">ë‚˜ë§Œì˜ ê¸´ ê¸€ ì§“ê¸° ğŸ“</h2>
                                    <p className="text-sm text-gray-500 mt-1">
                                        {emotionSequence.length > 0 ? "ìƒìì˜ ë¬¸ì¥ì„ í´ë¦­í•´ì„œ ì´ì•¼ê¸° ì›ê³ ì§€ì— ë„£ì–´ë³´ì„¸ìš”." : "ììœ ë¡­ê²Œ ë‚˜ë§Œì˜ ì´ì•¼ê¸°ë¥¼ ì¨ë³´ì„¸ìš”."}
                                    </p>
                                </div>

                                {/* ì¬ë£Œ ìƒì (Sentence Blocks) - í´ë¦­í•˜ë©´ ì‚½ì…ë¨ */}
                                {emotionSequence.length > 0 && (
                                    <div className="bg-blue-50 border border-blue-100 p-4 rounded-2xl shadow-sm">
                                        <h4 className="text-xs font-bold text-blue-800 mb-2 flex items-center">
                                            <span className="mr-2 text-lg">ğŸ§°</span> ì´ì•¼ê¸° ì¬ë£Œ ìƒì (í´ë¦­í•´ì„œ ë„£ê¸°)
                                        </h4>
                                        <div className="grid grid-cols-1 gap-2">
                                            {emotionSequence.map((item, idx) => {
                                                const stage = STORY_STAGES[idx].name;
                                                const reason = reasons[idx] || "ë‚´ìš© ì—†ìŒ";
                                                // ë¬¸ì¥ êµ¬ì„±: ì´ìœ  -> ê°ì •
                                                const sentence = `${reason} (ê·¸ë˜ì„œ '${item.word}' ë§ˆìŒì´ ë“¤ì—ˆì–´ìš”)`;
                                                
                                                return (
                                                    <button key={idx} onClick={() => insertText(sentence + "\n")} className="sentence-card bg-white p-3 rounded-xl border border-blue-100 text-left flex items-start gap-3 hover:bg-blue-50">
                                                        <span className={`text-[10px] px-2 py-0.5 rounded font-bold whitespace-nowrap mt-0.5 ${STORY_STAGES[idx].badgeClass}`}>{stage}</span>
                                                        <span className="text-sm text-gray-700 font-hand leading-tight">{sentence}</span>
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}

                                <div className="w-full bg-yellow-50 border-2 border-yellow-200 rounded-2xl p-5 shadow-lg relative mt-2">
                                    <div className="absolute -top-3 left-4 bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-xs font-bold shadow-sm">ì›ê³ ì§€ (Draft)</div>
                                    <textarea 
                                        id="student-draft"
                                        className="w-full h-80 bg-transparent border-none focus:ring-0 text-gray-800 font-hand text-lg leading-loose resize-none placeholder-gray-300"
                                        value={studentDraft}
                                        onChange={(e) => setStudentDraft(e.target.value)}
                                        placeholder={emotionSequence.length > 0 ? "ìœ„ ìƒìì—ì„œ ë¬¸ì¥ì„ ëˆŒëŸ¬ë³´ì„¸ìš”. &#13;&#10;ê·¸ë¦¬ê³  ë‚´ìš©ì„ ë”í•˜ê±°ë‚˜ ê³ ì³ë³´ì„¸ìš”!" : "ì˜¤ëŠ˜ì˜ ê°ì •ê³¼ ì´ì•¼ê¸°ë¥¼ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”..."}
                                    ></textarea>
                                </div>

                                <div className="flex gap-3 w-full mt-2">
                                    {emotionSequence.length > 0 && <button onClick={() => setStep(3)} className="flex-1 bg-white border border-gray-200 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-50 transition">ë’¤ë¡œ</button>}
                                    <button onClick={generateAiStory} className="flex-[2] bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all flex items-center justify-center gap-2">
                                        <span>AI ì„ ìƒë‹˜ì—ê²Œ ë³´ì—¬ì£¼ê¸°</span> <span className="animate-pulse">âœ¨</span>
                                    </button>
                                </div>
                            </div>
                        )}

                        {step === 5 && (
                            <div className="w-full flex flex-col items-center animate-fade-in pb-10">
                                {isAnalyzing ? (
                                    <div className="flex flex-col items-center justify-center h-80 text-center w-full">
                                        <div className="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mb-6 relative">
                                            <div className="text-4xl animate-bounce">ğŸ¤–</div>
                                            <div className="absolute inset-0 border-4 border-indigo-100 rounded-full animate-ping opacity-20"></div>
                                        </div>
                                        <h3 className="text-xl font-bold text-indigo-800 mb-2">EAIM AIê°€ ê¸€ì„ ë‹¤ë“¬ê³  ìˆì–´ìš”</h3>
                                        <p className="text-sm text-gray-500">í•™ìƒì˜ ë©‹ì§„ ì´ˆê³ ë¥¼ ë” ë¹›ë‚˜ê²Œ ë§Œë“œëŠ” ì¤‘...</p>
                                    </div>
                                ) : (
                                    <div className="w-full space-y-6">
                                        <div className="text-center">
                                            <h2 className="text-2xl font-bold text-gray-800 font-hand">EAIM ì™„ì„± ìŠ¤í† ë¦¬ ğŸ“–</h2>
                                        </div>
                                        
                                        <div className="w-full bg-white border border-gray-200 rounded-2xl p-6 shadow-2xl relative overflow-hidden transform transition-all hover:scale-[1.01]">
                                            <div className="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                                            <pre className="font-hand text-xl text-gray-700 leading-loose typewriter">{finalStory}</pre>
                                            
                                            <div className="mt-8 pt-4 border-t-2 border-dashed border-gray-100 flex justify-between items-end">
                                                <div className="flex flex-col">
                                                    <span className="text-[10px] text-gray-400 uppercase tracking-wider font-bold">Polished by</span>
                                                    <span className="text-xs text-indigo-600 font-bold">EAIM AI Assistant</span>
                                                </div>
                                                <span className="text-xs text-gray-400 font-medium">{new Date().toLocaleDateString()}</span>
                                            </div>
                                        </div>

                                        <div className="space-y-3 pt-2">
                                            <button onClick={copyToClipboard} className="w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-4 rounded-xl font-bold text-lg shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                                                ìµœì¢… ì œì¶œ (ë³µì‚¬)
                                            </button>
                                            <div className="flex gap-3">
                                                <button onClick={() => setStep(4)} className="flex-1 bg-white border border-gray-300 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-50">ë‹¤ì‹œ ìˆ˜ì •í•˜ê¸°</button>
                                                <button onClick={handleReset} className="flex-1 bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold hover:bg-indigo-100">ìƒˆë¡œ í•˜ê¸° ğŸ”„</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {step === 2 && (
                        <div className="p-4 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-40 sticky bottom-0">
                             <div className="flex gap-3">
                                <button onClick={() => setStep(1)} className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-xl hover:bg-gray-200 transition">ì´ì „</button>
                                <button onClick={() => emotionSequence.length === 4 && setStep(3)} className={`flex-[2] py-3 rounded-xl font-bold text-lg shadow-md transition-all ${emotionSequence.length === 4 ? 'bg-indigo-600 text-white hover:bg-indigo-700 hover:scale-[1.02]' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>
                                    {emotionSequence.length === 4 ? 'ì´ì•¼ê¸° ì—°ê²°í•˜ê¸° ğŸ‘‰' : '4ë‹¨ê³„ë¥¼ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”'}
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AimStudentApp />);
    </script>
</body>
</html>