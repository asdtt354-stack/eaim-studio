<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì—ì„ ë®¤ì§€ì»¬ ë©”ì´ì»¤</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #2D0A14; color: #FFF; }
        .font-drama { font-family: 'Gowun Batang', serif; }
        .font-show { font-family: 'Black Han Sans', sans-serif; }
        
        .stage-curtain {
            background: linear-gradient(to bottom, #9F1239, #881337);
            border-bottom: 4px solid #FCD34D;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .spotlight {
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0) 70%);
        }

        .ticket-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s;
        }
        .ticket-input:focus {
            background: rgba(255, 255, 255, 0.2);
            border-color: #FCD34D;
            outline: none;
        }
        .ticket-input::placeholder { color: rgba(255, 255, 255, 0.3); }

        .cast-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        .cast-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #FCD34D;
        }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .typing-cursor::after { content: '|'; animation: blink 1s step-start infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Cue Sheet Table Styles */
        .cue-table th { background-color: #881337; color: #FCD34D; padding: 8px; font-size: 0.8rem; border: 1px solid #4a0410; white-space: nowrap; }
        .cue-table td { background-color: #fff; color: #000; padding: 0; font-size: 0.8rem; border: 1px solid #ddd; vertical-align: middle; }
        .cue-table tr:nth-child(even) td { background-color: #f9f9f9; }
        
        .cue-input {
            width: 100%; height: 100%; border: none; background: transparent; padding: 8px;
            font-family: 'Noto Sans KR', sans-serif; font-size: 0.8rem; outline: none;
        }
        .cue-input:focus { background-color: #FEF3C7; box-shadow: inset 0 0 0 2px #F59E0B; }
        
        /* Save Status Indicator */
        .save-status {
            position: fixed; bottom: 20px; right: 20px;
            background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 20px;
            font-size: 0.8rem; color: #FCD34D; z-index: 100;
            pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }
        .save-status.show { opacity: 1; }
    </style>
</head>
<body class="min-h-screen pb-20">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            // State Definitions
            const [step, setStep] = useState(1);
            const [title, setTitle] = useState('');
            const [genre, setGenre] = useState('');
            const [songCount, setSongCount] = useState('5');
            
            const [castList, setCastList] = useState([
                { role: 'ì£¼ì¸ê³µ', desc: '' },
                { role: 'ì•…ë‹¹', desc: '' },
                { role: 'ì¡°ë ¥ì', desc: '' }
            ]);
            
            const [scenes, setScenes] = useState(['', '', '', '', '']); 
            const [songs, setSongs] = useState(['', '', '', '', '']);    
            
            const [finalScript, setFinalScript] = useState('');
            const [cueSheetData, setCueSheetData] = useState([]);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [resultMode, setResultMode] = useState('script');
            const [saveMsg, setSaveMsg] = useState('');
            const fileInputRef = useRef(null);

            const STAGES = [
                { name: 'ì˜¤í”„ë‹ (ê¸°)', desc: 'ë°°ê²½ ì†Œê°œ, ì›…ì¥í•œ ì½”ëŸ¬ìŠ¤ (Opening Chorus)', songType: 'Opening Chorus', light: 'ì „ì²´ ì¡°ëª… (Full Bright)' },
                { name: 'ì‚¬ê±´ (ìŠ¹)', desc: 'ê°ˆë“± ì‹œì‘ (1ê³¡ ì´ìƒ)', songType: 'Conflict Song', light: 'ë¶€ë¶„ ì¡°ëª… (Spot) -> ì–´ë‘¡ê²Œ' },
                { name: 'ì ˆì • (ì „)', desc: 'ê°ì • í­ë°œ (1ê³¡ ì´ìƒ)', songType: 'Climax Solo/Duet', light: 'í•€ ì¡°ëª… (Pin Spot) & ë¶‰ì€ìƒ‰' },
                { name: 'í”¼ë‚ ë ˆ (ê²°)', desc: 'í•´ê²°, ëŒ€ë‹¨ì› (1ê³¡ ì´ìƒ)', songType: 'Finale Number', light: 'ë”°ëœ»í•œ ì „ì²´ ì¡°ëª… (Warm)' },
                { name: 'ì»¤íŠ¼ì½œ', desc: 'ì „ ì¶œì—°ì§„ ë–¼ì°½ & ì¸ì‚¬ (Sing-along)', songType: 'Ensemble Sing-along', light: 'ê°ì„ í¬í•¨ ì „ì²´ ì ë“± (All On)' }
            ];

            // --- [ê¸°ëŠ¥ 1] ìë™ ì €ì¥ ë° ë³µêµ¬ (Auto Save) ---
            useEffect(() => {
                const savedData = localStorage.getItem('eaimMusicalData');
                if (savedData) {
                    if (confirm("ì´ì „ì— ì‘ì—…í•˜ë˜ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        try {
                            const parsed = JSON.parse(savedData);
                            setTitle(parsed.title || '');
                            setGenre(parsed.genre || '');
                            setSongCount(parsed.songCount || '5');
                            setCastList(parsed.castList || []);
                            setScenes(parsed.scenes || ['', '', '', '', '']);
                            setSongs(parsed.songs || ['', '', '', '', '']);
                            if(parsed.finalScript) {
                                setFinalScript(parsed.finalScript);
                                setCueSheetData(parsed.cueSheetData);
                                setStep(parsed.step || 1);
                            }
                        } catch (e) { console.error("Load Error", e); }
                    }
                }
            }, []);

            useEffect(() => {
                const dataToSave = { step, title, genre, songCount, castList, scenes, songs, finalScript, cueSheetData };
                localStorage.setItem('eaimMusicalData', JSON.stringify(dataToSave));
                
                setSaveMsg('ìë™ ì €ì¥ë¨ ğŸ’¾');
                const timer = setTimeout(() => setSaveMsg(''), 2000);
                return () => clearTimeout(timer);
            }, [step, title, genre, songCount, castList, scenes, songs, finalScript, cueSheetData]);


            // --- [ê¸°ëŠ¥ 2] íŒŒì¼ ë‹¤ìš´ë¡œë“œ (File Download) ---
            const downloadFile = (content, fileName, mimeType) => {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleDownloadScript = () => {
                if (!finalScript) return alert("ëŒ€ë³¸ì´ ì•„ì§ ì™„ì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                downloadFile(finalScript, `${title}_ëŒ€ë³¸.txt`, "text/plain");
            };

            const handleDownloadCueSheet = () => {
                if (cueSheetData.length === 0) return alert("íì‹œíŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                let xlsContent = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                    <head><meta charset="UTF-8"></head><body>
                    <table border="1">
                        <thead>
                            <tr style="background-color: #881337; color: #ffffff;">
                                <th>ìˆœì„œ</th><th>êµ¬ë¶„</th><th>ë‚´ìš©</th><th>ìŒí–¥</th><th>ì¡°ëª…</th><th>ë¹„ê³ </th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cueSheetData.map((row, i) => `
                                <tr>
                                    <td>${i+1}</td>
                                    <td>${row.scene}</td>
                                    <td>${row.content}</td>
                                    <td>${row.sound}</td>
                                    <td>${row.light}</td>
                                    <td>${row.note}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table></body></html>`;
                downloadFile(xlsContent, `${title}_íì‹œíŠ¸.xls`, "application/vnd.ms-excel");
            };

            // --- [ê¸°ëŠ¥ 3] í”„ë¡œì íŠ¸ íŒŒì¼ ì €ì¥/ì—´ê¸° (Project Backup) ---
            const saveProjectFile = () => {
                const data = { title, genre, songCount, castList, scenes, songs, finalScript, cueSheetData, step };
                downloadFile(JSON.stringify(data), `${title}_í”„ë¡œì íŠ¸.json`, "application/json");
                alert("í”„ë¡œì íŠ¸ íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\në‚˜ì¤‘ì— 'ë¶ˆëŸ¬ì˜¤ê¸°'ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            };

            const loadProjectFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        setTitle(parsed.title || '');
                        setGenre(parsed.genre || '');
                        setSongCount(parsed.songCount || '5');
                        setCastList(parsed.castList || []);
                        setScenes(parsed.scenes || ['', '', '', '', '']);
                        setSongs(parsed.songs || ['', '', '', '', '']);
                        setFinalScript(parsed.finalScript || '');
                        setCueSheetData(parsed.cueSheetData || []);
                        setStep(parsed.step || 1);
                        alert("í”„ë¡œì íŠ¸ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤! ğŸ‰");
                    } catch (err) {
                        alert("ì˜¬ë°”ë¥¸ í”„ë¡œì íŠ¸ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");
                    }
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset input
            };


            // --- ê¸°ì¡´ ë¡œì§ ---
            const addCastMember = () => { setCastList([...castList, { role: '', desc: '' }]); };
            const removeCastMember = (index) => {
                if(castList.length <= 1) return alert("ìµœì†Œ 1ëª…ì˜ ë°°ìš°ëŠ” í•„ìš”í•´ìš”!");
                setCastList(castList.filter((_, i) => i !== index));
            };
            const updateCastMember = (index, field, value) => {
                const newList = [...castList]; newList[index][field] = value; setCastList(newList);
            };
            const handleSceneChange = (idx, val) => { const n = [...scenes]; n[idx] = val; setScenes(n); };
            const handleSongChange = (idx, val) => { const n = [...songs]; n[idx] = val; setSongs(n); };
            const handleCueChange = (idx, field, val) => {
                const newData = [...cueSheetData]; newData[idx][field] = val; setCueSheetData(newData);
            };

            const generateMusical = () => {
                if(!title) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                setIsAnalyzing(true);
                setStep(4);
                
                setTimeout(() => {
                    let script = `ğŸ­ [15ë¶„ ë‹¨ë§‰ ë®¤ì§€ì»¬ ê¸°íšì•ˆ] : ${title}\n`;
                    script += `ğŸª ì¥ë¥´: ${genre || 'ë¯¸ì •'} | â±ï¸ ì´ ëŸ¬ë‹íƒ€ì„: ì•½ 15ë¶„\n`;
                    script += `ğŸ¼ ëª©í‘œ ë„˜ë²„ ìˆ˜: ${songCount}ê³¡\n\n`; 
                    script += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                    script += `ğŸŒŸ ë“±ì¥ì¸ë¬¼ (CAST)\n`;
                    castList.forEach(member => { script += `  â€¢ ${member.role || 'ë°°ì—­ ë¯¸ì •'}: ${member.desc || 'ì„¤ëª… ì—†ìŒ'}\n`; });
                    script += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
                    script += `ğŸµ ì‹œë†‰ì‹œìŠ¤ & ë„˜ë²„ ë¦¬ìŠ¤íŠ¸\n\n`;
                    
                    STAGES.forEach((stage, idx) => {
                        const sceneContent = scenes[idx] || "ë‚´ìš© ë¯¸ì •";
                        const songTitle = songs[idx] || "Untitled";
                        script += `Scene ${idx+1}. [${stage.name}]\n`;
                        script += `ğŸ“œ ì¥ë©´: ${sceneContent}\n`;
                        script += `ğŸ¤ ë„˜ë²„: â™¬ ${songTitle}\n`;
                        let direction = "";
                        if (idx === 0) direction = "ë§‰ì´ ì˜¤ë¥´ë©´ ì „ ì¶œì—°ì§„(ì•™ìƒë¸”)ì´ ë“±ì¥í•˜ì—¬ ì›…ì¥í•œ ì½”ëŸ¬ìŠ¤ë¡œ ê´€ê°ì˜ ì‹œì„ ì„ ì‚¬ë¡œì¡ìœ¼ë©° ë°°ê²½ì„ ì„¤ëª…í•©ë‹ˆë‹¤.";
                        else if (idx === 4) direction = "ì¡°ëª…ì„ ê°ì„ê¹Œì§€ í™˜í•˜ê²Œ ë¹„ì¶”ê³ , ëª¨ë“  ë°°ìš°ê°€ ë¬´ëŒ€ ì•ìœ¼ë¡œ ë‚˜ì™€ ê´€ê°ê³¼ í•¨ê»˜ ë°•ìˆ˜ì¹˜ë©° 'ë–¼ì°½'ìœ¼ë¡œ ì‹ ë‚˜ê²Œ ë§ˆë¬´ë¦¬í•©ë‹ˆë‹¤.";
                        else direction = `ì´ ì¥ë©´ì€ 3ë¶„ ë‚´ì™¸ë¡œ ì†ë„ê° ìˆê²Œ ì§„í–‰í•˜ë©°, ì¡°ëª…ì€ ${['ì ì  ì–´ë‘¡ê²Œ', 'ê°•ë ¬í•œ ë¶‰ì€ìƒ‰ìœ¼ë¡œ', 'ë”°ëœ»í•˜ê³  í¬ë§ì°¨ê²Œ'][idx-1]} ì—°ì¶œí•©ë‹ˆë‹¤.`;
                        script += `   (AI ì—°ì¶œ ë…¸íŠ¸: ${direction})\n\n`;
                    });
                    script += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                    script += `ğŸ‘ ê°ì‚¬í•©ë‹ˆë‹¤ - EAIM Production`;
                    setFinalScript(script);

                    const initialCues = STAGES.map((stage, idx) => ({
                        scene: stage.name.split(' ')[0], 
                        content: scenes[idx] || "-",
                        sound: songs[idx] ? `â™¬ ${songs[idx]}` : "BGM",
                        light: stage.light,
                        note: idx === 0 ? 'ë§‰ ì˜¤í”ˆ' : idx === 4 ? 'ë§‰ ë‚´ë¦¼' : ''
                    }));
                    setCueSheetData(initialCues);
                    setIsAnalyzing(false);
                }, 1500);
            };

            const resetAll = () => { 
                if(confirm("ëª¨ë“  ë‚´ìš©ì„ ì§€ìš°ê³  ìƒˆë¡œ ë§Œë“¤ê¹Œìš”?")) {
                    localStorage.removeItem('eaimMusicalData');
                    window.location.reload(); 
                }
            };

            const renderCueSheet = () => (
                <div className="w-full bg-white rounded-lg shadow-lg overflow-hidden animate-fade-in">
                    <div className="p-2 bg-yellow-100 text-yellow-800 text-xs text-center border-b border-yellow-200">
                        ğŸ’¡ í‘œì˜ ì¹¸ì„ í´ë¦­í•˜ë©´ ë‚´ìš©ì„ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”!
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full cue-table text-left border-collapse min-w-[500px]">
                            <thead>
                                <tr>
                                    <th className="w-10 text-center">#</th>
                                    <th className="w-16">êµ¬ë¶„</th>
                                    <th>ë‚´ìš© (Content)</th>
                                    <th className="w-24">ìŒí–¥ (Sound)</th>
                                    <th className="w-24">ì¡°ëª… (Light)</th>
                                    <th className="w-16">ë¹„ê³ </th>
                                </tr>
                            </thead>
                            <tbody>
                                {cueSheetData.map((row, idx) => (
                                    <tr key={idx}>
                                        <td className="text-center font-bold">{idx + 1}</td>
                                        <td className="font-bold text-gray-700 bg-gray-50">{row.scene}</td>
                                        <td><input type="text" className="cue-input" value={row.content} onChange={(e) => handleCueChange(idx, 'content', e.target.value)} /></td>
                                        <td><input type="text" className="cue-input text-blue-600 font-bold" value={row.sound} onChange={(e) => handleCueChange(idx, 'sound', e.target.value)} /></td>
                                        <td><input type="text" className="cue-input text-red-600 font-bold" value={row.light} onChange={(e) => handleCueChange(idx, 'light', e.target.value)} /></td>
                                        <td><input type="text" className="cue-input" value={row.note} onChange={(e) => handleCueChange(idx, 'note', e.target.value)} /></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#1a0509] shadow-2xl flex flex-col relative border-x-4 border-[#4a0410]">
                    
                    {/* Save Status Indicator */}
                    <div className={`save-status ${saveMsg ? 'show' : ''}`}>{saveMsg}</div>

                    {/* Header */}
                    <header className="stage-curtain p-6 text-center z-20 relative">
                        <div className="absolute top-0 left-0 w-full h-full spotlight pointer-events-none"></div>
                        <h1 className="text-3xl text-[#FCD34D] font-show drop-shadow-lg mb-1">ì—ì„ ë®¤ì§€ì»¬ ë©”ì´ì»¤</h1>
                        <p className="text-xs text-rose-200 font-drama">EAIM êµìœ¡ê³¼ í•¨ê»˜í•˜ëŠ” 15ë¶„ ë‹¨ë§‰ê·¹ ë§Œë“¤ê¸°</p>
                        
                        {/* Project Save/Load Buttons */}
                        <div className="absolute top-4 right-4 flex gap-2">
                            <button onClick={saveProjectFile} title="í”„ë¡œì íŠ¸ ì €ì¥" className="text-[#FCD34D] hover:text-white text-lg"><i className="fa-solid fa-file-arrow-down"></i></button>
                            <button onClick={() => fileInputRef.current.click()} title="í”„ë¡œì íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°" className="text-[#FCD34D] hover:text-white text-lg"><i className="fa-solid fa-folder-open"></i></button>
                            <input type="file" ref={fileInputRef} onChange={loadProjectFile} className="hidden" accept=".json" />
                        </div>
                    </header>

                    {/* Progress */}
                    <div className="flex justify-center gap-2 py-3 bg-[#2D0A14] sticky top-0 z-10 border-b border-[#4a0410]">
                        {[1, 2, 3, 4].map(s => (
                            <div key={s} className={`w-2 h-2 rounded-full transition-all ${step === s ? 'bg-[#FCD34D] w-6' : 'bg-gray-700'}`}></div>
                        ))}
                    </div>

                    <main className="flex-grow p-6 overflow-y-auto hide-scrollbar">
                        
                        {/* Step 1: Concept */}
                        {step === 1 && (
                            <div className="animate-fade-in space-y-6">
                                <div className="text-center">
                                    <span className="text-[#FCD34D] text-4xl mb-2 block">ğŸŸï¸</span>
                                    <h2 className="text-xl font-bold text-white font-drama">ì‘í’ˆì˜ ì»¨ì…‰ì„ ì •í•´ìš”</h2>
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-xs text-rose-300 block mb-1">ë®¤ì§€ì»¬ ì œëª© (Title)</label>
                                        <input type="text" className="w-full p-3 rounded-xl ticket-input text-lg font-bold text-center" 
                                            placeholder="ì˜ˆ: ìš°ë¦¬ë“¤ì˜ ë§ˆë²•í•™êµ" value={title} onChange={e => setTitle(e.target.value)} />
                                    </div>
                                    <div>
                                        <label className="text-xs text-rose-300 block mb-1">ì¥ë¥´ (Genre)</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            {['íŒíƒ€ì§€', 'í•™êµ/ì²­ì¶˜', 'ì—­ì‚¬/ì‹œëŒ€ê·¹', 'ì½”ë¯¸ë””'].map(g => (
                                                <button key={g} onClick={() => setGenre(g)} 
                                                    className={`p-2 rounded-lg text-sm border ${genre === g ? 'bg-[#FCD34D] text-[#2D0A14] border-[#FCD34D] font-bold' : 'bg-transparent text-gray-400 border-gray-700 hover:border-gray-500'}`}>
                                                    {g}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs text-rose-300 block mb-1">ëª©í‘œ ë„˜ë²„ ìˆ˜</label>
                                        <div className="flex items-center gap-2 bg-white/5 p-2 rounded-lg border border-white/10">
                                            <span className="text-lg">ğŸ¼</span>
                                            <input type="number" min="1" max="10" className="w-full bg-transparent text-white font-bold text-center outline-none" 
                                                value={songCount} onChange={e => setSongCount(e.target.value)} />
                                            <span className="text-xs text-gray-400 w-10">ê³¡</span>
                                        </div>
                                    </div>
                                </div>
                                <button onClick={() => setStep(2)} className="w-full bg-[#9F1239] hover:bg-[#BE123C] text-white py-4 rounded-xl font-bold font-show text-lg shadow-lg mt-8 transition transform active:scale-95">
                                    ìºìŠ¤íŒ… í•˜ëŸ¬ ê°€ê¸° ğŸ‘‰
                                </button>
                            </div>
                        )}

                        {/* Step 2: Casting */}
                        {step === 2 && (
                            <div className="animate-fade-in space-y-6">
                                <div className="text-center">
                                    <span className="text-[#FCD34D] text-4xl mb-2 block">ğŸ­</span>
                                    <h2 className="text-xl font-bold text-white font-drama">ë°°ìš°ë¥¼ ìºìŠ¤íŒ…í•´ìš”</h2>
                                </div>
                                <div className="space-y-4">
                                    {castList.map((member, idx) => (
                                        <div key={idx} className="cast-card p-4 rounded-xl relative group">
                                            <div className="flex gap-2 mb-2">
                                                <input type="text" className="w-1/3 p-1 bg-transparent border-b border-gray-600 text-yellow-300 text-sm font-bold placeholder-yellow-300/50 focus:outline-none focus:border-yellow-300" 
                                                    placeholder="ì—­í•  ì´ë¦„" value={member.role} onChange={(e) => updateCastMember(idx, 'role', e.target.value)} />
                                                <input type="text" className="flex-1 p-1 bg-transparent border-b border-gray-600 text-white text-sm placeholder-gray-500 focus:outline-none focus:border-white" 
                                                    placeholder="ì„¤ëª… / ë°°ìš° ì´ë¦„" value={member.desc} onChange={(e) => updateCastMember(idx, 'desc', e.target.value)} />
                                            </div>
                                            {castList.length > 1 && (
                                                <button onClick={() => removeCastMember(idx)} className="absolute top-2 right-2 text-gray-600 hover:text-red-500 transition opacity-0 group-hover:opacity-100 p-1">
                                                    <i className="fa-solid fa-trash-can"></i>
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                    <button onClick={addCastMember} className="w-full py-3 border-2 border-dashed border-gray-600 rounded-xl text-gray-400 hover:text-white hover:border-gray-400 transition flex items-center justify-center gap-2">
                                        <i className="fa-solid fa-plus-circle"></i> ë°°ì—­ ì¶”ê°€í•˜ê¸°
                                    </button>
                                </div>
                                <div className="flex gap-3 mt-8">
                                    <button onClick={() => setStep(1)} className="flex-1 bg-gray-800 text-gray-400 py-3 rounded-xl font-bold hover:bg-gray-700">ì´ì „</button>
                                    <button onClick={() => setStep(3)} className="flex-[2] bg-[#9F1239] hover:bg-[#BE123C] text-white py-3 rounded-xl font-bold shadow-lg">ìŠ¤í† ë¦¬ ì§œê¸° ğŸ‘‰</button>
                                </div>
                            </div>
                        )}

                        {/* Step 3: Plot & Songs */}
                        {step === 3 && (
                            <div className="animate-fade-in space-y-6 pb-10">
                                <div className="text-center">
                                    <span className="text-[#FCD34D] text-4xl mb-2 block">ğŸ¼</span>
                                    <h2 className="text-xl font-bold text-white font-drama">ì¥ë©´ê³¼ ë…¸ë˜ ë§Œë“¤ê¸°</h2>
                                </div>
                                
                                <div className="space-y-6">
                                    {STAGES.map((stage, idx) => (
                                        <div key={idx} className={`bg-[#2D0A14] border rounded-xl p-4 shadow-md relative overflow-hidden ${idx === 4 ? 'border-[#FCD34D] bg-[#2D0A14]/50' : 'border-[#4a0410]'}`}>
                                            <div className="absolute top-0 right-0 p-2 opacity-10 text-6xl font-show text-white">{idx === 4 ? 'â˜…' : idx+1}</div>
                                            <h3 className={`font-bold text-lg mb-1 ${idx === 4 ? 'text-[#FCD34D]' : 'text-white'}`}>{stage.name}</h3>
                                            <p className="text-[10px] text-gray-400 mb-3">{stage.desc}</p>
                                            
                                            <div className="space-y-2">
                                                <input type="text" className="w-full p-2 rounded-lg ticket-input text-sm" 
                                                    placeholder="ì–´ë–¤ ì¼ì´ ì¼ì–´ë‚˜ë‚˜ìš”?" value={scenes[idx]} onChange={e => handleSceneChange(idx, e.target.value)} />
                                                <div className="flex items-center gap-2">
                                                    <span className="text-lg">ğŸµ</span>
                                                    <input type="text" className="flex-1 p-2 rounded-lg ticket-input text-sm font-bold text-rose-200" 
                                                        placeholder={idx === 0 ? "ì½”ëŸ¬ìŠ¤ ì œëª©" : idx === 4 ? "ë–¼ì°½ ì œëª©" : "ë„˜ë²„ ì œëª©"} 
                                                        value={songs[idx]} onChange={e => handleSongChange(idx, e.target.value)} />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="flex gap-3 mt-8">
                                    <button onClick={() => setStep(2)} className="flex-1 bg-gray-800 text-gray-400 py-3 rounded-xl font-bold hover:bg-gray-700">ì´ì „</button>
                                    <button onClick={generateMusical} className="flex-[2] bg-gradient-to-r from-yellow-500 to-amber-600 text-black py-3 rounded-xl font-bold shadow-lg hover:scale-[1.02] transition-transform">
                                        AI ì—°ì¶œê°€ì—ê²Œ ë³´ë‚´ê¸° ğŸ¬
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Step 4: Final Result (Download Added) */}
                        {step === 4 && (
                            <div className="animate-fade-in flex flex-col items-center h-full">
                                {isAnalyzing ? (
                                    <div className="flex flex-col items-center justify-center h-80">
                                        <div className="text-6xl animate-bounce mb-4">ğŸ¤–ğŸ¬</div>
                                        <h3 className="text-xl font-bold text-white mb-2">AI ì—°ì¶œê°€ê°€ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤</h3>
                                        <p className="text-gray-400 text-sm">ëŒ€ë³¸ ì‘ì„± ë° íì‹œíŠ¸ ì¡°ëª… ì„¸íŒ… ì¤‘...</p>
                                    </div>
                                ) : (
                                    <div className="w-full space-y-4">
                                        <div className="flex justify-center gap-4 mb-2">
                                            <button onClick={() => setResultMode('script')} className={`px-4 py-2 rounded-full font-bold text-sm transition ${resultMode === 'script' ? 'bg-[#FCD34D] text-black' : 'bg-gray-800 text-gray-400'}`}>
                                                ğŸ“œ ëŒ€ë³¸ (Script)
                                            </button>
                                            <button onClick={() => setResultMode('cuesheet')} className={`px-4 py-2 rounded-full font-bold text-sm transition ${resultMode === 'cuesheet' ? 'bg-[#FCD34D] text-black' : 'bg-gray-800 text-gray-400'}`}>
                                                ğŸ“‘ íì‹œíŠ¸ (Cue Sheet)
                                            </button>
                                        </div>

                                        {resultMode === 'script' ? (
                                            <div className="bg-white/10 rounded-xl p-6 border border-white/20 shadow-2xl relative overflow-hidden animate-fade-in">
                                                <pre className="font-drama text-gray-200 text-sm leading-loose whitespace-pre-wrap typing-cursor">{finalScript}</pre>
                                            </div>
                                        ) : (
                                            renderCueSheet()
                                        )}

                                        <div className="grid grid-cols-2 gap-3 mt-4">
                                            {/* ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ */}
                                            {resultMode === 'script' ? (
                                                 <button onClick={handleDownloadScript} className="col-span-2 bg-[#FCD34D] hover:bg-yellow-400 text-[#2D0A14] py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                                                    <i className="fa-solid fa-file-arrow-down"></i> ëŒ€ë³¸ ë‹¤ìš´ë¡œë“œ (.txt)
                                                </button>
                                            ) : (
                                                <button onClick={handleDownloadCueSheet} className="col-span-2 bg-[#2ea043] hover:bg-[#3fb950] text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                                                    <i className="fa-solid fa-file-excel"></i> íì‹œíŠ¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                                                </button>
                                            )}
                                            
                                            <button onClick={() => setStep(3)} className="bg-gray-700 text-gray-300 py-3 rounded-xl font-bold">ìˆ˜ì •í•˜ê¸°</button>
                                            <button onClick={resetAll} className="bg-gray-700 text-gray-300 py-3 rounded-xl font-bold">ìƒˆë¡œ ë§Œë“¤ê¸°</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>