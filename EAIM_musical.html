<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì—ì„ ë®¤ì§€ì»¬ ë©”ì´ì»¤</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #2D0A14; color: #FFF; }
        .font-drama { font-family: 'Gowun Batang', serif; }
        .font-show { font-family: 'Black Han Sans', sans-serif; }
        
        .stage-curtain {
            background: linear-gradient(to bottom, #9F1239, #881337);
            border-bottom: 4px solid #FCD34D;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .spotlight {
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0) 70%);
        }

        .ticket-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s;
        }
        .ticket-input:focus {
            background: rgba(255, 255, 255, 0.2);
            border-color: #FCD34D;
            outline: none;
        }
        .ticket-input::placeholder { color: rgba(255, 255, 255, 0.3); }

        .cast-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        .cast-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #FCD34D;
        }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* í…ìŠ¤íŠ¸ ì„ íƒ í—ˆìš© í´ë˜ìŠ¤ */
        .allow-select { user-select: text !important; -webkit-user-select: text !important; cursor: text; }

        .cue-table th { background-color: #881337; color: #FCD34D; padding: 8px; font-size: 0.8rem; border: 1px solid #4a0410; white-space: nowrap; }
        .cue-table td { background-color: #fff; color: #000; padding: 0; font-size: 0.8rem; border: 1px solid #ddd; vertical-align: middle; }
        .cue-table tr:nth-child(even) td { background-color: #f9f9f9; }
        
        .cue-input {
            width: 100%; height: 100%; border: none; background: transparent; padding: 8px;
            font-family: 'Noto Sans KR', sans-serif; font-size: 0.8rem; outline: none;
        }
        .cue-input:focus { background-color: #FEF3C7; box-shadow: inset 0 0 0 2px #F59E0B; }
        
        .save-status {
            position: fixed; bottom: 20px; right: 20px;
            background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 20px;
            font-size: 0.8rem; color: #FCD34D; z-index: 100;
            pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }
        .save-status.show { opacity: 1; }

        /* --- [ì¤‘ìš”] ì¸ì‡„ìš© ìŠ¤íƒ€ì¼ (Print CSS) --- */
        @media print {
            body { background-color: white !important; color: black !important; }
            .no-print { display: none !important; } 
            .print-only { display: block !important; }
            
            .app-container { 
                box-shadow: none !important; border: none !important; margin: 0 !important; 
                max-width: 100% !important; width: 100% !important; height: auto !important; overflow: visible !important;
            }
            .print-content-area {
                background: white !important; color: black !important; border: none !important; box-shadow: none !important; padding: 0 !important;
            }
            .font-drama { color: black !important; white-space: pre-wrap !important; }
            .cue-table th { background-color: #eee !important; color: black !important; border: 1px solid #000 !important; }
            .cue-table td { border: 1px solid #000 !important; }
            input { border: none !important; }
            /* ëŒ€ë³¸ ê°€ì‚¬ ë“± ìƒ‰ìƒ ì¡°ì • */
            .text-yellow-200 { color: #555 !important; }
            .text-rose-200 { color: #000 !important; font-weight: bold !important; }
        }
    </style>
</head>
<body class="min-h-screen pb-20 print:bg-white print:pb-0">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [step, setStep] = useState(1);
            const [title, setTitle] = useState('');
            const [genre, setGenre] = useState('');
            const [songCount, setSongCount] = useState('5');
            
            const [castList, setCastList] = useState([
                { role: 'ì£¼ì¸ê³µ', desc: '' },
                { role: 'ì•…ë‹¹', desc: '' },
                { role: 'ì¡°ë ¥ì', desc: '' }
            ]);
            
            const [scenes, setScenes] = useState(['', '', '', '', '']); 
            const [songs, setSongs] = useState(['', '', '', '', '']);    
            
            const [finalScript, setFinalScript] = useState('');
            const [cueSheetData, setCueSheetData] = useState([]);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [resultMode, setResultMode] = useState('script');
            const [saveMsg, setSaveMsg] = useState('');
            const fileInputRef = useRef(null);

            const STAGES = [
                { name: 'ì˜¤í”„ë‹ (ê¸°)', desc: 'ë°°ê²½ ì†Œê°œ, ì›…ì¥í•œ ì½”ëŸ¬ìŠ¤', songType: 'Musical Opening Chorus, Grand, Energetic', light: 'ì „ì²´ ì¡°ëª… (Full Bright)' },
                { name: 'ì‚¬ê±´ (ìŠ¹)', desc: 'ê°ˆë“± ì‹œì‘', songType: 'Tension, Minor Key, Fast Tempo', light: 'ë¶€ë¶„ ì¡°ëª… (Spot) -> ì–´ë‘¡ê²Œ' },
                { name: 'ì ˆì • (ì „)', desc: 'ê°ì • í­ë°œ', songType: 'Dramatic Power Ballad, Emotional, High Notes', light: 'í•€ ì¡°ëª… (Pin Spot) & ë¶‰ì€ìƒ‰' },
                { name: 'í”¼ë‚ ë ˆ (ê²°)', desc: 'í•´ê²°, ëŒ€ë‹¨ì›', songType: 'Touching, Hopeful, Major Key', light: 'ë”°ëœ»í•œ ì „ì²´ ì¡°ëª… (Warm)' },
                { name: 'ì»¤íŠ¼ì½œ', desc: 'ì „ ì¶œì—°ì§„ ë–¼ì°½', songType: 'Upbeat, Curtain Call, Festival Style', light: 'ê°ì„ í¬í•¨ ì „ì²´ ì ë“± (All On)' }
            ];

            useEffect(() => {
                const savedData = localStorage.getItem('eaimMusicalData');
                if (savedData) {
                    if (confirm("ì´ì „ì— ì‘ì—…í•˜ë˜ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        try {
                            const parsed = JSON.parse(savedData);
                            setTitle(parsed.title || '');
                            setGenre(parsed.genre || '');
                            setSongCount(parsed.songCount || '5');
                            setCastList(parsed.castList || []);
                            setScenes(parsed.scenes || ['', '', '', '', '']);
                            setSongs(parsed.songs || ['', '', '', '', '']);
                            if(parsed.finalScript) {
                                setFinalScript(parsed.finalScript);
                                setCueSheetData(parsed.cueSheetData);
                                setStep(parsed.step || 1);
                            }
                        } catch (e) { console.error("Load Error", e); }
                    }
                }
            }, []);

            useEffect(() => {
                const dataToSave = { step, title, genre, songCount, castList, scenes, songs, finalScript, cueSheetData };
                localStorage.setItem('eaimMusicalData', JSON.stringify(dataToSave));
                setSaveMsg('ìë™ ì €ì¥ë¨ ğŸ’¾');
                setTimeout(() => setSaveMsg(''), 2000);
            }, [step, title, genre, songCount, castList, scenes, songs, finalScript, cueSheetData]);

            const downloadFile = (content, fileName, mimeType) => {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    alert(`ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! : ${text}`);
                }).catch(err => {
                    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                });
            };

            const handlePrint = () => {
                window.print();
            };

            const saveProjectFile = () => {
                const data = { title, genre, songCount, castList, scenes, songs, finalScript, cueSheetData, step };
                downloadFile(JSON.stringify(data), `${title}_í”„ë¡œì íŠ¸.json`, "application/json");
                alert("í”„ë¡œì íŠ¸ íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const loadProjectFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        setTitle(parsed.title || '');
                        setGenre(parsed.genre || '');
                        setSongCount(parsed.songCount || '5');
                        setCastList(parsed.castList || []);
                        setScenes(parsed.scenes || ['', '', '', '', '']);
                        setSongs(parsed.songs || ['', '', '', '', '']);
                        setFinalScript(parsed.finalScript || '');
                        setCueSheetData(parsed.cueSheetData || []);
                        setStep(parsed.step || 1);
                        alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! ğŸ‰");
                    } catch (err) { alert("íŒŒì¼ ì˜¤ë¥˜"); }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const addCastMember = () => { setCastList([...castList, { role: '', desc: '' }]); };
            const removeCastMember = (index) => {
                if(castList.length <= 1) return alert("ìµœì†Œ 1ëª… í•„ìš”");
                setCastList(castList.filter((_, i) => i !== index));
            };
            const updateCastMember = (index, field, value) => {
                const newList = [...castList]; newList[index][field] = value; setCastList(newList);
            };
            const handleSceneChange = (idx, val) => { const n = [...scenes]; n[idx] = val; setScenes(n); };
            const handleSongChange = (idx, val) => { const n = [...songs]; n[idx] = val; setSongs(n); };
            const handleCueChange = (idx, field, val) => {
                const newData = [...cueSheetData]; newData[idx][field] = val; setCueSheetData(newData);
            };

            // --- [ê°€ìƒ ëŒ€ì‚¬ ìƒì„±ê¸°] ---
            const generateMockDialogue = (stageIdx, castList, context) => {
                const mainChar = castList[0]?.role || "ì£¼ì¸ê³µ";
                const subChar = castList[1]?.role || "ì¡°ì—°";
                const thirdChar = castList[2]?.role || "ì•™ìƒë¸”";
                let dialogue = "";
                
                if (stageIdx === 0) {
                    dialogue += `${mainChar}: (ë“±ì¥í•˜ë©°) ${context || 'ì´ê³³ì—ì„œ ì´ì•¼ê¸°ê°€ ì‹œì‘ë¼.'} ì •ë§ ë–¨ë¦¬ëŠ”êµ°.\n`;
                    dialogue += `${subChar}: ê±±ì • ë§ˆ. ìš°ë¦° ì¤€ë¹„ëì–ì•„?\n`;
                    dialogue += `${thirdChar}: (ë‹¤ê°™ì´) ì, ì‹œì‘í•´ë³´ì!`;
                } else if (stageIdx === 1) {
                    dialogue += `${subChar}: í°ì¼ ë‚¬ì–´! ${context || 'ë¬¸ì œê°€ ë°œìƒí–ˆì–´.'}\n`;
                    dialogue += `${mainChar}: ë­? ê·¸ê²Œ ì‚¬ì‹¤ì´ì•¼?\n`;
                    dialogue += `${thirdChar}: ì–´ë–¡í•˜ì§€... ë¶„ìœ„ê¸°ê°€ ì‹¬ìƒì¹˜ ì•Šì•„.`;
                } else if (stageIdx === 2) {
                    dialogue += `${mainChar}: (ì ˆê·œí•˜ë©°) ë„ëŒ€ì²´ ì™œ ë‚˜ì—ê²Œ ì´ëŸ° ì‹œë ¨ì´! ${context || 'ë„ˆë¬´ í˜ë“¤ì–´.'}\n`;
                    dialogue += `${subChar}: í¬ê¸°í•˜ì§€ ë§ˆ. ë„Œ í•  ìˆ˜ ìˆì–´.\n`;
                } else if (stageIdx === 3) {
                    dialogue += `${mainChar}: ë“œë””ì–´ í•´ëƒˆì–´. ${context || 'ëª¨ë“ ê²Œ í•´ê²°ëì–´.'}\n`;
                    dialogue += `${subChar}: ë„¤ ë•ë¶„ì´ì•¼.\n`;
                    dialogue += `${thirdChar}: ì™€ì•„! (í™˜í˜¸)`;
                } else if (stageIdx === 4) {
                    dialogue += `${mainChar}: ê´€ê° ì—¬ëŸ¬ë¶„ ê°ì‚¬í•©ë‹ˆë‹¤!\n`;
                    dialogue += `${subChar}: (ì†ì„ í”ë“¤ë©°) ë‹¤ìŒì— ë˜ ë§Œë‚˜ìš”!\n`;
                }
                return dialogue;
            };

            // --- [NEW] ê°€ì‚¬(Lyrics) ìƒì„±ê¸° ---
            const generateMockLyrics = (stageIdx, songTitle, context) => {
                let lyrics = "";
                const keywords = context ? context.split(' ') : ['ê¿ˆ', 'í¬ë§'];
                const keyWord = keywords[0] || 'ìš°ë¦¬';

                if (stageIdx === 0) { // ì˜¤í”„ë‹
                    lyrics += `(Verse 1)\në§‰ì´ ì˜¤ë¥´ê³  ìƒˆë¡œìš´ ì„¸ìƒì´ ì—´ë ¤\nì—¬ê¸° ${keyWord}ì˜ ì´ì•¼ê¸°ê°€ ì‹œì‘ë˜ë„¤\nê°€ìŠ´ ë›°ëŠ” ì†Œë¦¬ê°€ ë“¤ë¦¬ë‹ˆ\n\n`;
                    lyrics += `(Chorus)\n${songTitle}! ì˜¤, ${songTitle}!\nìš°ë¦¬ì˜ ê¿ˆì„ ë…¸ë˜í•´\në‹¤ í•¨ê»˜ ì™¸ì³ë´, ì´ ìˆœê°„ì„ ê¸°ì–µí•´\ní™˜ìƒì˜ ë¬´ëŒ€ ìœ„ë¡œ ì´ˆëŒ€í• ê²Œ!`;
                } else if (stageIdx === 1) { // ê°ˆë“±
                    lyrics += `(Verse 1)\nì–´ë‘ ì´ ë‚´ë ¤ì™€, ë­”ê°€ ì˜ëª»ëì–´\n${keyWord}ë¼ëŠ” ë§ì´ ë¬´ìƒ‰í•´ì ¸\nì°¨ê°€ìš´ ë°”ëŒì´ ë¶ˆì–´ì˜¤ë„¤\n\n`;
                    lyrics += `(Chorus)\në„ëŒ€ì²´ ì™œ, ${songTitle}ì¸ê°€\ní”¼í•  ìˆ˜ ì—†ëŠ” ìš´ëª… ì•ì—ì„œ\në‚˜ëŠ” ê¸¸ì„ ìƒê³  í—¤ë§¤ì´ë„¤\në‹µì„ ì°¾ì„ ìˆ˜ ìˆì„ê¹Œ?`;
                } else if (stageIdx === 2) { // ì ˆì •
                    lyrics += `(Verse 1)\në” ì´ìƒ ë¬¼ëŸ¬ì„¤ ê³³ì€ ì—†ì–´\nì‹¬ì¥ì´ í„°ì§ˆ ê²ƒë§Œ ê°™ì•„\në‚˜ë¥¼ ì§“ëˆ„ë¥´ëŠ” ë¬´ê²Œë¥¼ ê²¬ëŒ\n\n`;
                    lyrics += `(Chorus)\n${songTitle}! ë‚˜ëŠ” í¬ê¸°í•˜ì§€ ì•Šì•„\në‚˜ì˜ ëª©ì†Œë¦¬ë¥¼ ë“¤ì–´ë´\nì € í•˜ëŠ˜ ëê¹Œì§€ ë‹¿ì„ ë•Œê¹Œì§€\në‚˜ì˜ ëª¨ë“  ê±¸ ë¶ˆíƒœìš°ë¦¬ë¼!`;
                } else if (stageIdx === 3) { // í”¼ë‚ ë ˆ (í•´ê²°)
                    lyrics += `(Verse 1)\ní­í’ì€ ì§€ë‚˜ê³  í–‡ì‚´ì´ ë¹„ì¶”ë„¤\nìš°ë¦¬ê°€ í•¨ê»˜ ê±¸ì–´ì˜¨ ì´ ê¸¸\n${keyWord}ì˜ ì˜ë¯¸ë¥¼ ì´ì œ ì•Œê² ì–´\n\n`;
                    lyrics += `(Chorus)\n${songTitle}, ì•„ë¦„ë‹¤ìš´ ë‚ ë“¤ì´ì—¬\nì„œë¡œì˜ ì†ì„ ì¡ê³  ë‚˜ì•„ê°€ì\nì‚¬ë‘ê³¼ í¬ë§ì´ ê°€ë“í•œ ê³³ìœ¼ë¡œ\nì˜ì›íˆ í•¨ê»˜ í•  ë…¸ë˜!`;
                } else if (stageIdx === 4) { // ì»¤íŠ¼ì½œ (ë–¼ì°½)
                    lyrics += `(All Together)\nì˜¤ëŠ˜ì„ ê¸°ì–µí•´ ì£¼ì„¸ìš”\nìš°ë¦¬ì˜ ë•€ë°©ìš¸ê³¼ ì›ƒìŒì„\n${songTitle}ì˜ ë©œë¡œë””ì— ë‹´ì•„\nì—¬ëŸ¬ë¶„ê»˜ ë°”ì¹©ë‹ˆë‹¤!\n\n`;
                    lyrics += `(Chorus)\në„ë„ë¼ ë„ë„ë¼ í•¨ê»˜ ë¶ˆëŸ¬ìš”\n${songTitle}! ì—í—¤ë¼ë””ì•¼!\në‹¤ì‹œ ë§Œë‚  ê·¸ë‚ ê¹Œì§€ ì•ˆë…•\nì‚¬ë‘í•©ë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤! (Yeah!)`;
                }
                return lyrics;
            };

            const generateMusical = () => {
                if(!title) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                setIsAnalyzing(true);
                setStep(4);
                
                setTimeout(() => {
                    let script = `ğŸ­ [15ë¶„ ë‹¨ë§‰ ë®¤ì§€ì»¬ ëŒ€ë³¸] : ${title}\n`;
                    script += `ğŸª ì¥ë¥´: ${genre || 'ë¯¸ì •'} | ğŸ¼ ${songCount}ê³¡\n`;
                    script += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                    script += `ğŸŒŸ ë“±ì¥ì¸ë¬¼ (CAST)\n`;
                    castList.forEach(member => { script += ` â€¢ ${member.role}: ${member.desc}\n`; });
                    script += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
                    
                    STAGES.forEach((stage, idx) => {
                        const sceneContent = scenes[idx] || "ë‚´ìš© ì—†ìŒ";
                        const songTitle = songs[idx] || "Untitled";
                        
                        script += `Scene ${idx+1}. [${stage.name}]\n`;
                        script += `(ìƒí™©: ${sceneContent})\n\n`;
                        
                        script += `[ ëŒ€ ì‚¬ (Dialogue) ]\n`;
                        script += generateMockDialogue(idx, castList, sceneContent);
                        script += `\n\n`;
                        
                        // [NEW] ê°€ì‚¬ ì¶”ê°€ ë¶€ë¶„
                        script += `ğŸµ Musical Number ${idx+1}: â™¬ ${songTitle}\n`;
                        script += `   (Mood: ${stage.songType})\n`;
                        script += `   ----------------------------------\n`;
                        script += generateMockLyrics(idx, songTitle, sceneContent); // ê°€ì‚¬ ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ
                        script += `\n   ----------------------------------\n`;
                        script += `\n\n`;
                    });
                    
                    script += `EAIM Production - ${new Date().toLocaleDateString()} Created`;
                    setFinalScript(script);

                    const initialCues = STAGES.map((stage, idx) => ({
                        scene: stage.name.split(' ')[0], 
                        content: scenes[idx] || "-",
                        sound: songs[idx] ? `â™¬ ${songs[idx]}` : "BGM",
                        light: stage.light,
                        note: idx === 0 ? 'ë§‰ ì˜¤í”ˆ' : idx === 4 ? 'ë§‰ ë‚´ë¦¼' : ''
                    }));
                    setCueSheetData(initialCues);
                    setIsAnalyzing(false);
                }, 1500);
            };

            const resetAll = () => { 
                if(confirm("ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    localStorage.removeItem('eaimMusicalData');
                    window.location.reload(); 
                }
            };

            const renderCueSheet = () => (
                <div className="w-full bg-white rounded-lg shadow-lg overflow-hidden animate-fade-in print:shadow-none print:border-none">
                    <div className="p-2 bg-yellow-100 text-yellow-800 text-xs text-center border-b border-yellow-200 no-print">
                        ğŸ’¡ ì¹¸ì„ í´ë¦­í•´ ìˆ˜ì • | ë“œë˜ê·¸í•´ì„œ ë³µì‚¬ ê°€ëŠ¥
                    </div>
                    <div className="overflow-x-auto print:overflow-visible">
                        <table className="w-full cue-table text-left border-collapse min-w-[500px]">
                            <thead>
                                <tr>
                                    <th className="w-10 text-center">#</th>
                                    <th className="w-16">êµ¬ë¶„</th>
                                    <th>ë‚´ìš© (Content)</th>
                                    <th className="w-24">ìŒí–¥ (Sound)</th>
                                    <th className="w-24">ì¡°ëª… (Light)</th>
                                    <th className="w-16">ë¹„ê³ </th>
                                </tr>
                            </thead>
                            <tbody className="allow-select">
                                {cueSheetData.map((row, idx) => (
                                    <tr key={idx}>
                                        <td className="text-center font-bold">{idx + 1}</td>
                                        <td className="font-bold text-gray-700 bg-gray-50">{row.scene}</td>
                                        <td><input type="text" className="cue-input" value={row.content} onChange={(e) => handleCueChange(idx, 'content', e.target.value)} /></td>
                                        <td><input type="text" className="cue-input text-blue-600 font-bold" value={row.sound} onChange={(e) => handleCueChange(idx, 'sound', e.target.value)} /></td>
                                        <td><input type="text" className="cue-input text-red-600 font-bold" value={row.light} onChange={(e) => handleCueChange(idx, 'light', e.target.value)} /></td>
                                        <td><input type="text" className="cue-input" value={row.note} onChange={(e) => handleCueChange(idx, 'note', e.target.value)} /></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            return (
                <div className="app-container max-w-md mx-auto min-h-screen bg-[#1a0509] shadow-2xl flex flex-col relative border-x-4 border-[#4a0410]">
                    
                    <div className={`save-status no-print ${saveMsg ? 'show' : ''}`}>{saveMsg}</div>

                    <header className="stage-curtain p-6 text-center z-20 relative no-print">
                        <div className="absolute top-0 left-0 w-full h-full spotlight pointer-events-none"></div>
                        <h1 className="text-3xl text-[#FCD34D] font-show drop-shadow-lg mb-1">ì—ì„ ë®¤ì§€ì»¬ ë©”ì´ì»¤</h1>
                        <p className="text-xs text-rose-200 font-drama">15ë¶„ ë‹¨ë§‰ê·¹ ëŒ€ë³¸ & íì‹œíŠ¸ ìƒì„±ê¸°</p>
                        <div className="absolute top-4 right-4 flex gap-2">
                            <button onClick={saveProjectFile} title="ì €ì¥" className="text-[#FCD34D] hover:text-white text-lg"><i className="fa-solid fa-file-arrow-down"></i></button>
                            <button onClick={() => fileInputRef.current.click()} title="ì—´ê¸°" className="text-[#FCD34D] hover:text-white text-lg"><i className="fa-solid fa-folder-open"></i></button>
                            <input type="file" ref={fileInputRef} onChange={loadProjectFile} className="hidden" accept=".json" />
                        </div>
                    </header>

                    <div className="flex justify-center gap-2 py-3 bg-[#2D0A14] sticky top-0 z-10 border-b border-[#4a0410] no-print">
                        {[1, 2, 3, 4].map(s => (
                            <div key={s} className={`w-2 h-2 rounded-full transition-all ${step === s ? 'bg-[#FCD34D] w-6' : 'bg-gray-700'}`}></div>
                        ))}
                    </div>

                    <main className="flex-grow p-6 overflow-y-auto hide-scrollbar">
                        
                        {step === 1 && (
                            <div className="animate-fade-in space-y-6">
                                <div className="text-center">
                                    <span className="text-[#FCD34D] text-4xl mb-2 block">ğŸŸï¸</span>
                                    <h2 className="text-xl font-bold text-white font-drama">ì‘í’ˆ ì»¨ì…‰ ì„¤ì •</h2>
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-xs text-rose-300 block mb-1">ë®¤ì§€ì»¬ ì œëª©</label>
                                        <input type="text" className="w-full p-3 rounded-xl ticket-input text-lg font-bold text-center" 
                                            placeholder="ì˜ˆ: ë§ˆë²•ì˜ ìˆ²" value={title} onChange={e => setTitle(e.target.value)} />
                                    </div>
                                    <div>
                                        <label className="text-xs text-rose-300 block mb-1">ì¥ë¥´</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            {['íŒíƒ€ì§€', 'í•™êµ', 'ì‹œëŒ€ê·¹', 'ì½”ë¯¸ë””'].map(g => (
                                                <button key={g} onClick={() => setGenre(g)} 
                                                    className={`p-2 rounded-lg text-sm border ${genre === g ? 'bg-[#FCD34D] text-[#2D0A14] font-bold' : 'bg-transparent text-gray-400 border-gray-700'}`}>
                                                    {g}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <button onClick={() => setStep(2)} className="w-full bg-[#9F1239] hover:bg-[#BE123C] text-white py-4 rounded-xl font-bold mt-8">ë‹¤ìŒ: ìºìŠ¤íŒ… ğŸ‘‰</button>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="animate-fade-in space-y-6">
                                <div className="text-center"><h2 className="text-xl font-bold text-white font-drama">ë°°ìš° ìºìŠ¤íŒ…</h2></div>
                                <div className="space-y-4">
                                    {castList.map((member, idx) => (
                                        <div key={idx} className="cast-card p-4 rounded-xl relative">
                                            <div className="flex gap-2 mb-2">
                                                <input type="text" className="w-1/3 p-1 bg-transparent border-b border-gray-600 text-yellow-300 font-bold" 
                                                    placeholder="ì—­í• " value={member.role} onChange={(e) => updateCastMember(idx, 'role', e.target.value)} />
                                                <input type="text" className="flex-1 p-1 bg-transparent border-b border-gray-600 text-white" 
                                                    placeholder="ì„¤ëª…" value={member.desc} onChange={(e) => updateCastMember(idx, 'desc', e.target.value)} />
                                            </div>
                                            {castList.length > 1 && <button onClick={() => removeCastMember(idx)} className="absolute top-2 right-2 text-gray-500"><i className="fa-solid fa-trash-can"></i></button>}
                                        </div>
                                    ))}
                                    <button onClick={addCastMember} className="w-full py-3 border-2 border-dashed border-gray-600 rounded-xl text-gray-400">ë°°ì—­ ì¶”ê°€ +</button>
                                </div>
                                <div className="flex gap-3 mt-8">
                                    <button onClick={() => setStep(1)} className="flex-1 bg-gray-800 text-gray-400 py-3 rounded-xl font-bold">ì´ì „</button>
                                    <button onClick={() => setStep(3)} className="flex-[2] bg-[#9F1239] text-white py-3 rounded-xl font-bold">ë‹¤ìŒ: ìŠ¤í† ë¦¬ ğŸ‘‰</button>
                                </div>
                            </div>
                        )}

                        {step === 3 && (
                            <div className="animate-fade-in space-y-6 pb-10">
                                <div className="text-center"><h2 className="text-xl font-bold text-white font-drama">ì¥ë©´ êµ¬ì„±</h2></div>
                                <div className="space-y-6">
                                    {STAGES.map((stage, idx) => (
                                        <div key={idx} className={`bg-[#2D0A14] border rounded-xl p-4 relative ${idx === 4 ? 'border-[#FCD34D]' : 'border-[#4a0410]'}`}>
                                            <div className="absolute top-0 right-0 p-2 opacity-10 text-6xl font-show text-white">{idx+1}</div>
                                            <h3 className="font-bold text-lg mb-1 text-white">{stage.name}</h3>
                                            <input type="text" className="w-full p-2 mb-2 rounded-lg ticket-input text-sm" 
                                                placeholder="ì¥ë©´ ë‚´ìš©" value={scenes[idx]} onChange={e => handleSceneChange(idx, e.target.value)} />
                                            <div className="flex items-center gap-2">
                                                <span className="text-lg">ğŸµ</span>
                                                <input type="text" className="flex-1 p-2 rounded-lg ticket-input text-sm text-rose-200" 
                                                    placeholder="ë…¸ë˜ ì œëª©" value={songs[idx]} onChange={e => handleSongChange(idx, e.target.value)} />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-3 mt-8">
                                    <button onClick={() => setStep(2)} className="flex-1 bg-gray-800 text-gray-400 py-3 rounded-xl font-bold">ì´ì „</button>
                                    <button onClick={generateMusical} className="flex-[2] bg-gradient-to-r from-yellow-500 to-amber-600 text-black py-3 rounded-xl font-bold">AI ì—°ì¶œí•˜ê¸° ğŸ¬</button>
                                </div>
                            </div>
                        )}

                        {step === 4 && (
                            <div className="animate-fade-in flex flex-col items-center h-full">
                                {isAnalyzing ? (
                                    <div className="flex flex-col items-center justify-center h-80">
                                        <div className="text-6xl animate-bounce mb-4">ğŸ¤–</div>
                                        <h3 className="text-xl font-bold text-white">ëŒ€ë³¸ & ê°€ì‚¬ ì‘ì„± ì¤‘...</h3>
                                    </div>
                                ) : (
                                    <div className="w-full space-y-4">
                                        <div className="flex justify-center gap-4 mb-2 no-print">
                                            <button onClick={() => setResultMode('script')} className={`px-4 py-2 rounded-full font-bold text-sm ${resultMode === 'script' ? 'bg-[#FCD34D] text-black' : 'bg-gray-800 text-gray-400'}`}>ğŸ“œ ëŒ€ë³¸</button>
                                            <button onClick={() => setResultMode('cuesheet')} className={`px-4 py-2 rounded-full font-bold text-sm ${resultMode === 'cuesheet' ? 'bg-[#FCD34D] text-black' : 'bg-gray-800 text-gray-400'}`}>ğŸ“‘ íì‹œíŠ¸</button>
                                        </div>

                                        {resultMode === 'script' ? (
                                            <div className="bg-white/10 rounded-xl p-6 border border-white/20 shadow-2xl relative print-content-area">
                                                <div className="no-print text-center text-xs text-gray-400 mb-2">âœ¨ í…ìŠ¤íŠ¸ë¥¼ ë“œë˜ê·¸í•´ì„œ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ âœ¨</div>
                                                <pre className="font-drama text-gray-200 text-sm leading-loose whitespace-pre-wrap allow-select">{finalScript}</pre>
                                            </div>
                                        ) : (
                                            renderCueSheet()
                                        )}

                                        <div className="bg-[#2D0A14] border border-[#FCD34D]/30 p-4 rounded-xl mt-4 no-print">
                                            <h3 className="text-[#FCD34D] font-bold text-sm mb-2"><i className="fa-solid fa-music"></i> Suno AIìš© ë„˜ë²„ ë³µì‚¬í•˜ê¸°</h3>
                                            <div className="space-y-2">
                                                {songs.map((song, i) => song && (
                                                    <div key={i} className="flex items-center justify-between bg-white/5 p-2 rounded text-xs">
                                                        <span className="truncate flex-1 text-white mr-2">
                                                            <span className="text-yellow-500 font-bold">Track {i+1}:</span> [{STAGES[i].songType}] {song}
                                                        </span>
                                                        <button 
                                                            onClick={() => copyToClipboard(`[${STAGES[i].songType}] ${song}`)}
                                                            className="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded whitespace-nowrap"
                                                        >
                                                            ë³µì‚¬ <i className="fa-regular fa-copy"></i>
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-3 mt-4 no-print">
                                            <button onClick={handlePrint} className="col-span-2 bg-white text-black py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                                                <i className="fa-solid fa-print"></i> PDF ì €ì¥ / ì¸ì‡„
                                            </button>
                                            <button onClick={() => setStep(3)} className="bg-gray-700 text-gray-300 py-3 rounded-xl font-bold">ìˆ˜ì •</button>
                                            <button onClick={resetAll} className="bg-gray-700 text-gray-300 py-3 rounded-xl font-bold">ìƒˆë¡œ ë§Œë“¤ê¸°</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>